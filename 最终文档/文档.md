# 敏捷项目管理平台开发文档

# 目录

- [前言](#前言)
- [第 1 章 可行性研究](#第-1-章-可行性研究)
  - [1.1 系统概述](#11-系统概述)
  - [1.2 初步的系统分析设计](#12-初步的系统分析设计)
  - [1.3 技术可行性分析](#13-技术可行性分析)
  - [1.4 经济/效益可行性分析](#14-经济效益可行性分析)
  - [1.5 系统开发计划](#15-系统开发计划)
- [第 2 章 需求分析](#第-2-章-需求分析)
  - [2.1 总体目标](#21-总体目标)
  - [2.2 具体目标](#22-具体目标)
  - [2.3 系统数据建模 (E-R 图)](#23-系统数据建模-e-r-图)
  - [2.4 系统功能建模](#24-系统功能建模)
  - [2.5 完善的数据字典](#25-完善的数据字典)
- [第 3 章 总体设计](#第-3-章-总体设计)
  - [3.1 系统结构图](#31-系统结构图)
  - [3.2 数据库设计](#32-数据库设计)
  - [3.3 系统模块 IPO 表](#33-系统模块-ipo-表-输入-处理-输出)
- [第 4 章 详细设计](#第-4-章-详细设计)
  - [4.1 用户认证与个人中心模块](#41-用户认证与个人中心模块)
  - [4.2 项目管理核心模块](#42-项目管理核心模块)
  - [4.3 待办事项 (Backlog) 模块](#43-待办事项-backlog-模块)
  - [4.4 冲刺 (Sprint) 管理模块](#44-冲刺-sprint-管理模块)
  - [4.5 看板 (Kanban) 模块](#45-看板-kanban-模块)
  - [4.6 史诗 (Epic) 管理模块](#46-史诗-epic-管理模块)
  - [4.7 问题追踪 (Issue) 模块](#47-问题追踪-issue-模块)
  - [4.8 Wiki 与知识库模块](#48-wiki-与知识库模块)
  - [4.9 辅助功能模块](#49-辅助功能模块)
- [第 5 章 系统实现](#第-5-章-系统实现)
  - [5.1 开发平台和开发环境介绍](#51-开发平台和开发环境介绍)
  - [5.2 核心编码与实现](#52-核心编码与实现)
  - [5.3 各模块功能的实现](#53-各模块功能的实现)
  - [5.4 关键算法与逻辑实现](#54-关键算法与逻辑实现)
- [第 6 章 测试](#第-6-章-测试)
  - [6.1 软件测试目标](#61-软件测试目标)
  - [6.2 软件测试步骤](#62-软件测试步骤)
  - [6.3 单元测试与集成测试策略](#63-单元测试与集成测试策略)
  - [6.4 测试用例与结果](#64-测试用例与结果)
- [第 7 章 维护](#第-7-章-维护)
  - [7.1 系统维护过程](#71-系统维护过程)
  - [7.2 系统维护策略](#72-系统维护策略)
- [第 8 章 总结与体会](#第-8-章-总结与体会)
  - [8.1 总结](#81-总结)
  - [8.2 体会](#82-体会)
- [第 9 章 附录](#第-9-章-附录)
  - [附录 A：核心数据库表 SQL 定义](#附录-a核心数据库表-sql-定义)
  - [附录 B：API 接口文档概览](#附录-bapi-接口文档概览)
  - [附录 C：配置文件说明](#附录-c配置文件说明)

---

# 前言

本文档是根据软件工程的基本原理、开发方法以及开发过程进行了多次讨论与实践的成果。本系统按照软件生命周期的各个阶段相应的任务进行开发分析，主要包括可行性研究、需求分析、总体设计、详细设计、编码实现、测试与维护等内容，每一章节都图文并茂地阐述了具体的设计过程，使得该文档具有较高的可读性，便于开发人员进行设计和维护。

本项目是一个基于现有开源敏捷项目管理系统（Taiga/Tenzu）进行二次开发的全新敏捷项目管理平台。项目采用 Python/Django 语言、前后端分离架构（B/S 模式）、应用 Django REST Framework/Django-Ninja 开发框架和 PostgreSQL 数据库技术实现。本项目的核心工作包括：对比分析 Taiga 和 Tenzu 两个开源系统，将 Taiga 的成熟功能迁移到 Tenzu 架构，并实现自定义前端界面。同时，项目将采用微服务架构进行系统重构，应用 Strangler Fig（绞杀榕）模式和领域驱动设计（DDD）方法论。

---

# 第 1 章 可行性研究

## 1.1 系统概述

本项目是一个全新的敏捷项目管理平台，基于对现有开源系统 Taiga 和 Tenzu（天図）的深入分析和对比，综合两者优势进行二次开发。项目采用 Python/Django 语言、前后端分离的 B/S 架构模式，应用 Django REST Framework/Django-Ninja 开发框架和 PostgreSQL 数据库技术实现。

本系统的核心目标是将 Taiga 的成熟敏捷功能（Scrum + Kanban）迁移到 Tenzu 的现代技术栈（Django 5.2 + Angular 21），同时实现架构升级——从单体架构（Monolith）演进为微服务架构（Microservices）。系统功能主要包括两个方面：一方面通过 Scrum 敏捷框架，实现产品待办列表管理、冲刺规划、任务分解与燃尽图追踪等功能；另一方面通过 Kanban 看板方法，实现可视化的工作流管理、WIP（在制品）限制和持续交付流程优化。

从项目管理者的角度看，使用本系统能够使管理人员更方便地查看项目进度情况、团队成员的工作负载以及迭代完成情况等基本信息。从开发团队成员的角度看，使用本系统能方便地查看自己负责的任务、了解任务的优先级和依赖关系、及时更新任务状态，从而使团队协作更为高效。

### 1.1.0 项目背景：Taiga 与 Tenzu 的演进

**开发团队与版本演变**

Taiga 项目由 Kaleidos INC 公司开发维护。2024 年 4 月，Taiga 项目转让给 Taiga Cloud Services (TCS)，发布 Taiga 6 版本，采用 SaaS 收费模式（每月 5 欧元）。

开源版本仍在 https://github.com/taigaio 维护，功能完整但技术栈相对老旧。同时，TaigaNext 项目转让给 BIRU-Scop 公司，更名为 **Tenzu（天図）**，采用全新的技术栈进行重构。

**表 1.0 Taiga 与 Tenzu 版本对比**

| 特性       | Taiga 6 (开源版)          | Tenzu (天図)              |
| ---------- | ------------------------- | ------------------------- |
| 后端框架   | Django 3.2.25             | Django 5.2 (最新 LTS)     |
| 前端框架   | Angular 21 + TypeScript   | Angular 21                |
| API 文档   | REST API 手册             | Django-Ninja 自动生成     |
| 功能完整度 | 完整（Scrum + Kanban）    | 简化（仅看板）            |
| 生命周期   | Django 3.2 支持到 2024.04 | Django 5.2 支持到 2025.12 |

**部署实例**

| 系统           | 部署地址       | API 文档地址                    |
| -------------- | -------------- | ------------------------------- |
| Taiga (开源版) | taiga.etao.net | https://docs.taiga.io/api.html  |
| Tenzu (新版)   | se.etao.net    | https://se.etao.net/api/v1/docs |

本系统采用现代化的前后端分离架构，技术选型如表 1.1 所示：

**表 1.1 系统技术架构表**

| 层次        | 技术组件     | 版本    | 说明               |
| ----------- | ------------ | ------- | ------------------ |
| 前端框架    | Angular      | 21      | 单页应用框架       |
| 前端语言    | TypeScript   | 5.0+    | 编译为 JavaScript  |
| 前端构建    | Gulp         | 4.0.2   | 自动化构建工具     |
| 前端样式    | SASS         | 8.0.0   | CSS 预处理器       |
| 后端框架    | Django       | 5.2 LTS | Python Web 框架    |
| API 框架    | Django-Ninja | 1.0+    | RESTful API 构建   |
| 数据库      | PostgreSQL   | 14+     | 关系型数据库       |
| 缓存        | Redis        | 7+      | 内存缓存与消息队列 |
| 异步任务    | Celery       | 5.5.3   | 分布式任务队列     |
| WSGI 服务器 | Gunicorn     | 23.0.0  | 生产环境部署       |
| 实时通信    | taiga-events | -       | WebSocket 服务     |

### 1.1.2 与同类产品对比分析

为了更清晰地了解本系统的定位和优势，表 1.2 列出了与市场上主流敏捷项目管理工具的对比：

**表 1.2 敏捷项目管理工具对比表**

| 特性         | Taiga      | Jira         | Trello     | Azure DevOps |
| ------------ | ---------- | ------------ | ---------- | ------------ |
| 开源         | ✓ 完全开源 | ✗ 商业软件   | ✗ 商业软件 | ✗ 商业软件   |
| 自托管       | ✓ 支持     | ✓ 付费版支持 | ✗ 仅云端   | ✓ Server 版  |
| Scrum 支持   | ✓ 完整     | ✓ 完整       | ✗ 有限     | ✓ 完整       |
| Kanban 支持  | ✓ 完整     | ✓ 完整       | ✓ 完整     | ✓ 完整       |
| 燃尽图       | ✓ 内置     | ✓ 内置       | ✗ 需插件   | ✓ 内置       |
| 免费版限制   | 无限制     | 10 用户      | 有限功能   | 5 用户       |
| API 开放程度 | 完全开放   | 完全开放     | 完全开放   | 完全开放     |
| 学习曲线     | 低         | 高           | 低         | 中           |
| 中文支持     | ✓ 完整     | ✓ 完整       | ✓ 完整     | ✓ 完整       |

### 1.1.3 项目开发团队分工

本项目的开发工作由项目组成员分工协作完成，具体分工如表 1.3 所示：

**表 1.3 项目开发团队分工表**

| 角色       | 负责人 | 主要职责                              |
| ---------- | ------ | ------------------------------------- |
| 项目经理   | [姓名] | 项目整体规划、进度把控、文档审核      |
| 后端开发   | [姓名] | Django 后端开发、API 设计、数据库设计 |
| 前端开发   | [姓名] | Angular 前端开发、界面实现            |
| 测试工程师 | [姓名] | 测试用例设计、功能测试、性能测试      |
| 文档编写   | [姓名] | 需求文档、设计文档、用户手册编写      |

## 1.2 初步的系统分析设计

本系统包括以下几个系统模块：

1. **用户认证与权限模块**：该系统模块描述了系统访问控制的功能，具有用户注册、用户登录（支持 JWT Token 认证）、密码重置、邮箱验证、第三方 OAuth 登录（GitHub、GitLab 等）、角色权限配置等功能。

2. **项目管理模块**：该系统模块描述了项目级别的管理功能，具有创建项目（支持 Scrum/Kanban 模板）、项目配置（模块启用/禁用）、成员邀请与管理、角色权限分配、项目归档与删除等功能。

3. **Scrum 敏捷模块**：该系统模块描述了 Scrum 敏捷方法的核心功能，具有产品待办列表（Backlog）管理、用户故事创建与估点、史诗（Epic）管理、冲刺（Sprint）规划与执行、任务分解与跟踪、燃尽图生成与查看等功能。

4. **Kanban 看板模块**：该系统模块描述了 Kanban 可视化管理的功能，具有看板视图展示、泳道（Swimlane）配置、状态列管理、WIP 限制设置、卡片拖拽状态变更、过滤器与快速搜索等功能。

5. **问题追踪模块**：该系统模块描述了缺陷和问题管理的功能，具有问题创建与分类、优先级与严重程度设置、问题状态流转、问题指派与关注、自定义属性扩展等功能。

6. **Wiki 知识库模块**：该系统模块描述了团队知识管理的功能，具有 Wiki 页面创建与编辑（支持 Markdown）、页面版本历史、快捷链接管理、附件上传等功能。

7. **系统集成模块**：该系统模块描述了与外部系统对接的功能，具有 Webhook 配置与触发、GitHub/GitLab/Bitbucket 集成、项目数据导入（支持 Trello、Jira、Asana）、RESTful API 接口等功能。

---

### 1.2 初步的系统分析设计

#### 1.2.1 业务流程图

业务流程图是概括性描绘物理系统的传统工具。其基本思想是利用图形符号以黑匣子的形式描绘组成系统的各个部件。业务流程图强调的是数据在系统各部件间的流动情况，选择性地暂时忽略对各数据加工处理的控制过程。以一种物理数据流图的形式展现系统的各个功能运作流程，为人们初步理解项目系统提供帮助。

基于上述分析的七个系统模块，本项目系统的业务流程图如下图 1.1 至图 1.7 所示。每张业务流程图均基于系统 API 实现和服务层逻辑进行绘制。

##### (1) 用户注册与登录业务流程

用户认证流程基于 JWT (JSON Web Token) 机制实现。

**流程说明**：

1. **注册流程** (`/api/v1/auth/register`):

   - 用户提交注册信息（用户名、邮箱、密码）
   - 必须接受服务条款 (`accepted_terms`)
   - 支持公开注册 (`type=public`) 和私有注册 (`type=private`)
   - 进行相应处理
   - 返回认证信息 (`make_auth_response_data`)

2. **登录流程** (`/api/v1/auth`):

   - 用户提交凭据（用户名/邮箱 + 密码）
   - 支持多种登录方式 (`type=normal` 或第三方插件)
   - 通过相应模块
   - 如携带邀请令牌，自动接受项目邀请 (`accept_invitation_by_existing_user`)

3. **Token 刷新** (`/api/v1/auth/refresh`):
   - 使用 Refresh Token 获取新的 Access Token

![用户注册与登录业务流程](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch1/1_1_auth_flow.png)

##### (2) 项目创建与模板选择业务流程

项目创建通过 API 实现，支持从预设模板初始化项目配置。

**流程说明**：

1. 用户选择创建新项目
2. 选择项目类型：Scrum 模式 / Kanban 模式 / 空白项目
3. 填写项目基本信息（名称、描述、可见性）
4. 系统根据模板自动初始化：
   - 用户故事状态 (`UserStoryStatus`)
   - 任务状态 (`TaskStatus`)
   - 问题类型和状态 (`IssueType`, `IssueStatus`)
   - 优先级和严重程度 (`Priority`, `Severity`)
   - 故事点定义 (`Points`)
   - 默认角色和权限 (`Roles`)

![项目创建与模板选择流程](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch1/1_2_project_create.png)

##### (3) Scrum 模式：Sprint 规划与燃尽图生成流程

Sprint 管理。

**流程说明**：

1. **创建 Sprint**：设置名称、起止日期
2. **规划用户故事**：从 Backlog 拖拽用户故事到 Sprint
   - 进行相应处理
   - 同步更新关联任务的 `milestone` 字段
3. **任务分解**：为每个用户故事创建子任务
4. **执行 Sprint**：每日更新任务状态
5. **燃尽图计算**：根据剩余故事点动态计算进度曲线
6. **Sprint 完成判断**：
   - 进行相应处理
   - 若完成则进行相应处理

![Sprint规划与燃尽图流程](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch1/1_3_sprint_flow.png)

##### (4) Kanban 模式：任务卡片流转与泳道管理流程

Kanban 模式通过泳道 (Swimlane) 和状态列实现可视化管理，。

**流程说明**：

1. 创建/配置泳道 (`Swimlane`)
2. 定义状态列（如：待办、进行中、已完成）
3. 设置 WIP (Work In Progress) 限制
4. 卡片拖拽流转：
   - 进行相应处理
   - 支持 `before_userstory` / `after_userstory` 定位
5. 状态变更时自动重新计算

![Kanban任务卡片流转流程](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch1/1_4_kanban_flow.png)

##### (5) 用户故事 (User Story) 全生命周期管理流程

用户故事是系统的核心业务对象，完整生命周期管理。

**生命周期状态**：

| 状态           | 说明             |
| -------------- | ---------------- |
| New            | 新创建           |
| Backlog        | 在待办列表中排序 |
| Sprint         | 已规划到冲刺     |
| In Progress    | 开发中           |
| Ready for Test | 待测试           |
| Done           | 已完成           |
| Blocked        | 阻塞中           |

![用户故事生命周期流程](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch1/1_5_userstory_lifecycle.png)

##### (6) 问题 (Issue) 追踪与处理流程

问题追踪模块，用于 Bug 报告和支持请求管理。

**流程说明**：

1. 创建问题：填写标题、描述、类型、优先级、严重程度
2. 分配处理人
3. 状态流转（新建 → 进行中 → 已解决 → 已关闭）
4. 关联到 Sprint（可选）
5. 添加评论和附件
6. 关闭问题

![问题追踪与处理流程](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch1/1_6_issue_flow.png)

##### (7) 史诗 (Epic) 跨版本规划流程

史诗 (Epic) 用于管理跨多个 Sprint 的大型功能，。

**流程说明**：

1. 创建 Epic：设置标题、描述、颜色标识
2. 关联用户故事：通过相应模块
3. 进度聚合：自动计算关联用户故事的完成百分比
4. 跨版本追踪：Epic 可跨越多个 Sprint 周期

![史诗跨版本规划流程](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch1/1_7_epic_flow.png)

---

#### 1.2.2 数据流图 (DFD)

数据流图（DFD）是一种图形化技术，其描绘了信息流和数据从输入移动到输出的过程中所经受的变换。在数据流图中没有任何具体的物理部件，它只是描绘数据在软件中流动和被处理的逻辑过程，构建的是系统的逻辑模型。画数据流图的目的是利用它作为交流信息、分析和设计的工具。

数据流图采用分层的方式进行绘制，从顶层（Context Diagram）开始，逐层细化到更详细的处理过程。本节绘制三层数据流图，如图 1.8 至图 1.10 所示。

##### (1) 顶层数据流图 (Context Diagram)

顶层数据流图仅用一个加工过程 P0 来表示整个系统，用 E0、E1、E2 表示该系统全部的数据输入输出实体。顶层数据流图作用是在最高层次上展示数据流动情况，为后续进一步弄清系统数据流动和处理的过程夯实基础。

顶层数据流图展示系统与外部实体之间的数据交互关系。

**外部实体**：

- **用户 (User)**：普通项目成员，进行日常项目管理操作
- **管理员 (Admin)**：系统管理员，负责系统配置和用户管理
- **外部系统**：GitHub、GitLab、Jira 等第三方平台，通过 Webhook 与本系统交互

**主要数据流**：

- 登录/注册请求 → 系统
- 项目/任务操作 → 系统
- 系统响应/通知 ← 系统
- Webhook 事件 → 系统
- 数据读写 ↔ 项目数据库

![顶层数据流图](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch1/1_8_context_dfd.png)

##### (2) 0 层数据流图 (Level-0 DFD)

0 层数据流图将系统分解为 5 个主要处理过程。

| 处理过程编号 | 名称 | 对应模块 |
| ------------ | ---- | -------- |

**数据存储**：

- D1 用户表 (users_user)
- D2 项目表 (projects_project)
- D3 用户故事表 (userstories_userstory)
- D4 任务表 (tasks_task)
- D5 冲刺表 (milestones_milestone)
- D6 问题表 (issues_issue)
- D7 Wiki 表 (wiki_wikipage)

![0层数据流图](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch1/1_9_level0_dfd.png)

##### (3) 1 层数据流图：敏捷管理子系统

对 3.0 敏捷管理过程进行进一步分解，展示其内部子过程。

| 子过程编号 | 名称         | 功能说明                     |
| ---------- | ------------ | ---------------------------- |
| 3.1        | Backlog 管理 | 用户故事创建、排序、估点     |
| 3.2        | Sprint 规划  | 冲刺创建、故事分配、周期管理 |
| 3.3        | 任务管理     | 任务分解、状态跟踪、指派     |
| 3.4        | Kanban 管理  | 泳道配置、卡片流转、WIP 限制 |
| 3.5        | 燃尽图计算   | 进度统计、图表数据生成       |

**新增数据存储**：

- D8 泳道表 (projects_swimlane)
- D9 统计数据 (计算生成)

![1层数据流图-敏捷管理子系统](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch1/1_10_level1_agile_dfd.png)

---

#### 1.2.3 数据字典

数据字典是关于数据的信息的集合，也就是对数据流图中包含的所有元素的定义的集合，其主要功能是在软件分析和设计的过程中给人提供关于数据的描述信息。数据字典最重要的用途是作为分析阶段的工具，典型的情况是，在数据字典中记录数据元素的下列信息：一般信息（名称、描述）、定义（数据类型、长度、结构等）、使用特点（值的范围、使用频率、使用方式等）、控制信息（来源、用户、使用它的程序、改变权、使用权等）等。

本项目需要建立用户表、项目表、用户故事表、任务表、冲刺表、问题表、史诗表、成员角色表、Wiki 页面表等，其初步的数据字典如下表 1.4 至表 1.12 所示：

##### 表 1.4 用户 (User) 数据字典

| 字段名       | 数据类型     | 约束             | 说明           |
| ------------ | ------------ | ---------------- | -------------- |
| id           | INTEGER      | PK, AUTO         | 主键           |
| uuid         | CHAR(32)     | UNIQUE, NOT NULL | 用户唯一标识   |
| username     | VARCHAR(255) | UNIQUE, NOT NULL | 用户名         |
| email        | VARCHAR(255) | UNIQUE, NOT NULL | 邮箱地址       |
| password     | VARCHAR(128) | NOT NULL         | 密码哈希       |
| full_name    | VARCHAR(256) | NULL             | 全名           |
| bio          | TEXT         | NULL             | 个人简介       |
| photo        | VARCHAR(500) | NULL             | 头像路径       |
| color        | CHAR(9)      | NULL             | 用户颜色标识   |
| is_active    | BOOLEAN      | NOT NULL         | 是否激活       |
| is_superuser | BOOLEAN      | NOT NULL         | 是否超级管理员 |
| date_joined  | TIMESTAMP    | NOT NULL         | 注册时间       |
| lang         | VARCHAR(20)  | NULL             | 默认语言       |
| timezone     | VARCHAR(20)  | NULL             | 时区设置       |

##### 表 1.2 项目 (Project) 数据字典

| 字段名               | 数据类型     | 约束            | 说明         |
| -------------------- | ------------ | --------------- | ------------ |
| id                   | INTEGER      | PK, AUTO        | 主键         |
| name                 | VARCHAR(250) | NOT NULL        | 项目名称     |
| slug                 | VARCHAR(250) | UNIQUE          | URL 友好标识 |
| description          | TEXT         | NULL            | 项目描述     |
| owner_id             | INTEGER      | FK → users_user | 项目所有者   |
| is_private           | BOOLEAN      | NOT NULL        | 是否私有     |
| is_backlog_activated | BOOLEAN      | NOT NULL        | 启用 Backlog |
| is_kanban_activated  | BOOLEAN      | NOT NULL        | 启用 Kanban  |
| is_wiki_activated    | BOOLEAN      | NOT NULL        | 启用 Wiki    |
| is_issues_activated  | BOOLEAN      | NOT NULL        | 启用问题追踪 |
| total_milestones     | INTEGER      | NULL            | 冲刺总数     |
| total_story_points   | DECIMAL      | NULL            | 故事点总数   |
| created_date         | TIMESTAMP    | NOT NULL        | 创建时间     |

##### 表 1.3 用户故事 (UserStory) 数据字典

| 字段名         | 数据类型  | 约束                          | 说明           |
| -------------- | --------- | ----------------------------- | -------------- |
| id             | INTEGER   | PK, AUTO                      | 主键           |
| ref            | BIGINT    | INDEX                         | 项目内引用编号 |
| project_id     | INTEGER   | FK → projects_project         | 所属项目       |
| milestone_id   | INTEGER   | FK → milestones_milestone     | 所属冲刺       |
| owner_id       | INTEGER   | FK → users_user               | 创建者         |
| assigned_to_id | INTEGER   | FK → users_user               | 负责人         |
| status_id      | INTEGER   | FK → projects_userstorystatus | 状态           |
| swimlane_id    | INTEGER   | FK → projects_swimlane        | 泳道           |
| subject        | TEXT      | NOT NULL                      | 标题           |
| description    | TEXT      | NULL                          | 描述           |
| is_closed      | BOOLEAN   | NOT NULL                      | 是否关闭       |
| backlog_order  | BIGINT    | NOT NULL                      | Backlog 排序   |
| sprint_order   | BIGINT    | NOT NULL                      | Sprint 排序    |
| kanban_order   | BIGINT    | NOT NULL                      | Kanban 排序    |
| created_date   | TIMESTAMP | NOT NULL                      | 创建时间       |
| finish_date    | TIMESTAMP | NULL                          | 完成时间       |

##### 表 1.4 任务 (Task) 数据字典

| 字段名          | 数据类型  | 约束                       | 说明           |
| --------------- | --------- | -------------------------- | -------------- |
| id              | INTEGER   | PK, AUTO                   | 主键           |
| ref             | BIGINT    | INDEX                      | 项目内引用编号 |
| project_id      | INTEGER   | FK → projects_project      | 所属项目       |
| user_story_id   | INTEGER   | FK → userstories_userstory | 所属用户故事   |
| milestone_id    | INTEGER   | FK → milestones_milestone  | 所属冲刺       |
| owner_id        | INTEGER   | FK → users_user            | 创建者         |
| assigned_to_id  | INTEGER   | FK → users_user            | 负责人         |
| status_id       | INTEGER   | FK → projects_taskstatus   | 状态           |
| subject         | TEXT      | NOT NULL                   | 标题           |
| description     | TEXT      | NULL                       | 描述           |
| us_order        | BIGINT    | NOT NULL                   | 用户故事内排序 |
| taskboard_order | BIGINT    | NOT NULL                   | 任务板排序     |
| is_iocaine      | BOOLEAN   | NOT NULL                   | 是否为紧急任务 |
| finished_date   | TIMESTAMP | NULL                       | 完成时间       |

##### 表 1.5 冲刺/里程碑 (Milestone) 数据字典

| 字段名           | 数据类型     | 约束                  | 说明         |
| ---------------- | ------------ | --------------------- | ------------ |
| id               | INTEGER      | PK, AUTO              | 主键         |
| name             | VARCHAR(200) | NOT NULL              | 冲刺名称     |
| slug             | VARCHAR(250) | NOT NULL              | URL 友好标识 |
| project_id       | INTEGER      | FK → projects_project | 所属项目     |
| owner_id         | INTEGER      | FK → users_user       | 创建者       |
| estimated_start  | DATE         | NULL                  | 预计开始日期 |
| estimated_finish | DATE         | NULL                  | 预计结束日期 |
| closed           | BOOLEAN      | NOT NULL              | 是否关闭     |
| disponibility    | DECIMAL      | NULL                  | 团队可用工时 |
| order            | INTEGER      | NOT NULL              | 排序         |

##### 表 1.6 问题 (Issue) 数据字典

| 字段名         | 数据类型 | 约束                      | 说明           |
| -------------- | -------- | ------------------------- | -------------- |
| id             | INTEGER  | PK, AUTO                  | 主键           |
| ref            | BIGINT   | INDEX                     | 项目内引用编号 |
| project_id     | INTEGER  | FK → projects_project     | 所属项目       |
| milestone_id   | INTEGER  | FK → milestones_milestone | 关联冲刺       |
| owner_id       | INTEGER  | FK → users_user           | 报告者         |
| assigned_to_id | INTEGER  | FK → users_user           | 负责人         |
| status_id      | INTEGER  | FK → projects_issuestatus | 状态           |
| type_id        | INTEGER  | FK → projects_issuetype   | 类型           |
| priority_id    | INTEGER  | FK → projects_priority    | 优先级         |
| severity_id    | INTEGER  | FK → projects_severity    | 严重程度       |
| subject        | TEXT     | NOT NULL                  | 标题           |
| description    | TEXT     | NULL                      | 描述           |
| is_closed      | BOOLEAN  | NOT NULL                  | 是否关闭       |

##### 表 1.7 史诗 (Epic) 数据字典

| 字段名         | 数据类型 | 约束                     | 说明           |
| -------------- | -------- | ------------------------ | -------------- |
| id             | INTEGER  | PK, AUTO                 | 主键           |
| ref            | BIGINT   | INDEX                    | 项目内引用编号 |
| project_id     | INTEGER  | FK → projects_project    | 所属项目       |
| owner_id       | INTEGER  | FK → users_user          | 创建者         |
| assigned_to_id | INTEGER  | FK → users_user          | 负责人         |
| status_id      | INTEGER  | FK → projects_epicstatus | 状态           |
| subject        | TEXT     | NOT NULL                 | 标题           |
| description    | TEXT     | NULL                     | 描述           |
| color          | CHAR(9)  | NOT NULL                 | 颜色标识       |
| epics_order    | BIGINT   | NOT NULL                 | 排序           |

##### 表 1.8 成员与角色 (Membership & Role) 数据字典

| 字段名                | 数据类型     | 约束                  | 说明           |
| --------------------- | ------------ | --------------------- | -------------- |
| id                    | INTEGER      | PK, AUTO              | 主键           |
| project_id            | INTEGER      | FK → projects_project | 所属项目       |
| user_id               | INTEGER      | FK → users_user       | 成员用户       |
| role_id               | INTEGER      | FK → users_role       | 角色           |
| is_admin              | BOOLEAN      | NOT NULL              | 是否项目管理员 |
| email                 | VARCHAR(255) | NULL                  | 邀请邮箱       |
| invited_by_id         | INTEGER      | FK → users_user       | 邀请者         |
| invitation_extra_text | TEXT         | NULL                  | 邀请附加信息   |
| token                 | VARCHAR(60)  | NULL                  | 邀请令牌       |
| created_at            | TIMESTAMP    | NOT NULL              | 创建时间       |

| 字段名      | 数据类型     | 约束                  | 说明           |
| ----------- | ------------ | --------------------- | -------------- |
| id          | INTEGER      | PK, AUTO              | 主键           |
| name        | VARCHAR(200) | NOT NULL              | 角色名称       |
| slug        | VARCHAR(250) | NOT NULL              | URL 友好标识   |
| project_id  | INTEGER      | FK → projects_project | 所属项目       |
| permissions | TEXT[]       | NULL                  | 权限列表       |
| order       | INTEGER      | NOT NULL              | 排序           |
| computable  | BOOLEAN      | NOT NULL              | 是否计入故事点 |

##### 表 1.9 Wiki 页面与链接数据字典

| 字段名        | 数据类型     | 约束                  | 说明                |
| ------------- | ------------ | --------------------- | ------------------- |
| id            | INTEGER      | PK, AUTO              | 主键                |
| project_id    | INTEGER      | FK → projects_project | 所属项目            |
| owner_id      | INTEGER      | FK → users_user       | 创建者              |
| slug          | VARCHAR(500) | NOT NULL              | URL 友好标识        |
| content       | TEXT         | NULL                  | 页面内容 (Markdown) |
| created_date  | TIMESTAMP    | NOT NULL              | 创建时间            |
| modified_date | TIMESTAMP    | NOT NULL              | 修改时间            |
| version       | INTEGER      | NOT NULL              | 版本号              |

| 字段名     | 数据类型     | 约束                  | 说明     |
| ---------- | ------------ | --------------------- | -------- |
| id         | INTEGER      | PK, AUTO              | 主键     |
| project_id | INTEGER      | FK → projects_project | 所属项目 |
| title      | VARCHAR(500) | NOT NULL              | 链接标题 |
| href       | VARCHAR(500) | NOT NULL              | 链接目标 |
| order      | BIGINT       | NOT NULL              | 排序     |

---

### 1.3 技术可行性分析

本项目采用的开发工具为 PostgreSQL、Visual Studio Code 和 PyCharm，实现基于 Django-Ninja 的 Python 后端完全能够胜任此次开发。因为本系统服务的用户阈值为中小型软件开发团队（通常 5-50 人），考虑到用户同时操作项目的并发性不是非常高，而 PostgreSQL 是一个功能强大的开源关系型数据库管理系统，被广泛应用于各类 Web 应用中。由于其对 JSONB 的原生支持、强大的全文检索能力、以及完善的事务处理机制，本项目选择了 PostgreSQL 作为后端数据库。

Django 是一个高级 Python Web 框架，其"开箱即用"的设计理念使得开发者能够快速构建安全、可维护的 Web 应用。Django-Ninja 在 Django 基础上提供了强大的 API 开发能力，支持自动生成 OpenAPI 文档，使本系统能够以标准化的 RESTful 风格提供接口服务。

同时，为了高质量完成本软件系统开发工作，还需要遵循如下准则：

(1) 做好数据的规划，建立稳定的信息模型；

(2) 在功能模块的划分上，按业务领域来划分子系统或模块；

(3) 应用软件的开发设计，要充分考虑应用软件的可扩展性，建立友好的用户界面。

综上所述，系统的实现技术上完全可行。

#### 1.3.1 后端技术栈 (Django/Python/DRF)

本系统后端采用成熟稳定的技术栈：

| 技术         | 版本         | 用途            |
| ------------ | ------------ | --------------- |
| Python       | 3.10+        | 核心运行环境    |
| Django       | 3.2.25 (LTS) | Web 框架        |
| Django-Ninja | 1.0+         | RESTful API     |
| Celery       | 5.5.3        | 异步任务队列    |
| Redis        | 6.4.0        | 缓存/消息代理   |
| psycopg2     | 2.9.10       | PostgreSQL 驱动 |
| Gunicorn     | 23.0.0       | WSGI 服务器     |

**技术优势**：

- Django LTS 版本提供长期安全支持
- DRF 提供标准化的 API 开发范式
- Celery + Redis 支持高并发异步任务处理
- 丰富的第三方库支持（markdown、pillow、lxml 等）

#### 1.3.2 前端技术栈 (Angular/TypeScript)

基于 `package.json` 分析，前端采用以下技术：

| 技术       | 版本   | 用途              |
| ---------- | ------ | ----------------- |
| Angular    | 21     | MVC 框架          |
| TypeScript | 5.0+   | JavaScript 预处理 |
| Gulp       | 4.0.2  | 构建工具          |
| SASS       | 8.0.0  | CSS 预处理器      |
| Jade/Pug   | 1.11.0 | HTML 模板引擎     |
| Dragula    | 3.7.2  | 拖拽功能          |
| Flot       | 0.8.3  | 图表渲染          |

**技术特点**：

- Angular 响应式表单简化开发
- TypeScript 提供类型安全
- Gulp 自动化构建流程
- 完整的国际化支持 (angular-translate)

#### 1.3.3 数据库选型 (PostgreSQL) 与实时通信 (WebSocket)

**数据库选型**：

| 特性       | PostgreSQL | MySQL      |
| ---------- | ---------- | ---------- |
| JSONB 支持 | ✓ 原生支持 | ✗ 需要扩展 |
| 数组字段   | ✓ 原生支持 | ✗ 不支持   |
| 全文检索   | ✓ 内置     | 需要配置   |
| 并发控制   | MVCC       | MVCC       |

本系统选择 PostgreSQL 的原因：

- JSONB 字段存储自定义属性 (Custom Attributes)
- 数组字段存储权限列表和标签
- 强大的全文检索能力支持项目搜索

**实时通信**：

- 基于 WebSocket 实现实时事件推送
- 使用 Redis Pub/Sub 作为消息代理
- 支持看板拖拽、评论等操作的实时同步

---

### 1.4 经济/效益可行性分析

#### 1.4.1 开发成本估算

| 成本项     | 估算金额   | 说明                      |
| ---------- | ---------- | ------------------------- |
| 人力成本   | ¥500,000+  | 4-6 人开发团队，6-12 个月 |
| 服务器成本 | ¥12,000/年 | 云服务器 (2 核 4G)        |
| 域名/SSL   | ¥1,000/年  | 域名注册与证书            |
| 第三方服务 | ¥5,000/年  | 邮件服务、CDN 等          |

**开源替代方案**：

- 基于 Taiga/Tenzu 开源系统二次开发可节省数十万开发成本
- 仅需投入服务器运维和定制化开发成本

#### 1.4.2 运行环境与维护费用

**最低配置要求**：

| 组件 | 配置      |
| ---- | --------- |
| CPU  | 2 核心    |
| 内存 | 4 GB      |
| 存储 | 50 GB SSD |
| 带宽 | 5 Mbps    |

**年度维护费用估算**：

- 服务器托管：¥8,000 - 15,000
- 数据备份：¥1,000 - 3,000
- 安全更新：¥2,000 - 5,000
- 技术支持：¥10,000 - 30,000

#### 1.4.3 预期经济效益与团队协作效率提升

**效率提升指标**：

| 指标           | 预期提升 |
| -------------- | -------- |
| 需求响应速度   | +40%     |
| 迭代交付周期   | -25%     |
| 缺陷发现率     | +30%     |
| 团队沟通成本   | -35%     |
| 项目可视化程度 | +60%     |

**ROI 分析**：

- 投资回报周期：8-12 个月
- 年节约成本：相比商业软件可节省 ¥50,000-100,000 许可费

---

### 1.5 系统开发计划

| 阶段     | 时间        | 主要工作              | 交付物                 |
| -------- | ----------- | --------------------- | ---------------------- |
| 第一阶段 | 第 1-2 周   | 需求分析与设计        | SRS 文档、原型图       |
| 第二阶段 | 第 3-4 周   | 数据库设计与 API 开发 | 数据库脚本、API 文档   |
| 第三阶段 | 第 5-6 周   | 核心功能实现          | 用户/项目/Backlog 模块 |
| 第四阶段 | 第 7-8 周   | Sprint/Kanban 实现    | 敏捷管理核心功能       |
| 第五阶段 | 第 9-10 周  | 集成与测试            | 测试报告、缺陷修复     |
| 第六阶段 | 第 11-12 周 | 部署与上线            | 生产环境、用户手册     |

---

## 第 2 章 需求分析

### 2.1 总体目标

本项目的目标意在依托当前敏捷开发方法论的广泛普及和软件团队对高效协作工具的迫切需求，为软件开发团队提供一个**开源、轻量、易用**的敏捷项目管理平台。

对项目管理者而言，如何更方便、更直观地掌握项目进度、如何花费更少的时间和精力进行迭代规划和资源分配是该项目主要考虑的实现目标；而对开发团队成员而言，本项目主要的实现目标考虑的是如何提高任务可见性来增强团队协作效率、如何减少沟通成本以及如何更方便地追踪工作状态来实现持续改进开发流程。

本系统的主要目标包括：

1. **支持主流敏捷方法论**：完整实现 Scrum 和 Kanban 两种敏捷框架
2. **提供直观的可视化界面**：通过看板、燃尽图等工具提升团队协作效率
3. **实现灵活的权限管理**：支持项目级别的角色权限配置
4. **保障数据安全与隐私**：支持私有部署，满足企业数据安全需求
5. **提供开放的集成能力**：通过 RESTful API 和 Webhook 与第三方系统集成

### 2.2 具体目标

#### (1) 账户与权限管理模块

**功能需求**：

| 需求编号     | 功能         | 优先级 | 说明                              |
| ------------ | ------------ | ------ | --------------------------------- |
| REQ-AUTH-001 | 用户注册     | 高     | 支持邮箱注册，需接受服务条款      |
| REQ-AUTH-002 | 用户登录     | 高     | 支持用户名/邮箱+密码登录          |
| REQ-AUTH-003 | 第三方登录   | 中     | 支持 GitHub、GitLab 等 OAuth 登录 |
| REQ-AUTH-004 | 密码重置     | 高     | 通过邮箱验证重置密码              |
| REQ-AUTH-005 | 个人资料管理 | 中     | 修改头像、简介、语言、时区等      |
| REQ-AUTH-006 | 角色定义     | 高     | 项目级别角色，支持自定义权限      |
| REQ-AUTH-007 | 成员邀请     | 高     | 通过邮箱邀请成员加入项目          |

#### (2) Scrum 敏捷迭代模块

**功能需求**：

| 需求编号      | 功能         | 优先级 | 说明                         |
| ------------- | ------------ | ------ | ---------------------------- |
| REQ-SCRUM-001 | 产品待办列表 | 高     | 用户故事创建、排序、估点     |
| REQ-SCRUM-002 | Sprint 规划  | 高     | 创建冲刺周期，拖拽分配故事   |
| REQ-SCRUM-003 | 任务分解     | 高     | 将用户故事分解为子任务       |
| REQ-SCRUM-004 | 任务板       | 高     | 可视化展示 Sprint 内任务状态 |
| REQ-SCRUM-005 | 燃尽图       | 中     | 实时计算并展示冲刺进度       |
| REQ-SCRUM-006 | 速度图       | 低     | 跟踪团队历史交付能力         |
| REQ-SCRUM-007 | 故事点估算   | 高     | 多角色估点，自动聚合         |

#### (3) Kanban 可视化看板模块

**功能需求**：

| 需求编号       | 功能     | 优先级 | 说明                               |
| -------------- | -------- | ------ | ---------------------------------- |
| REQ-KANBAN-001 | 看板视图 | 高     | 按状态列展示用户故事               |
| REQ-KANBAN-002 | 泳道管理 | 中     | 支持多泳道分类（如按负责人、类型） |
| REQ-KANBAN-003 | WIP 限制 | 中     | 设置进行中工作数量上限             |
| REQ-KANBAN-004 | 拖拽操作 | 高     | 拖拽卡片改变状态/排序              |
| REQ-KANBAN-005 | 快速编辑 | 中     | 在看板上快速编辑卡片信息           |
| REQ-KANBAN-006 | 过滤器   | 中     | 按负责人、标签等过滤卡片           |

#### (4) 问题追踪与 Wiki 知识库模块

**问题追踪功能**：

| 需求编号      | 功能     | 优先级 | 说明                            |
| ------------- | -------- | ------ | ------------------------------- |
| REQ-ISSUE-001 | 问题创建 | 高     | 创建 Bug、支持请求等            |
| REQ-ISSUE-002 | 问题分类 | 高     | 类型、优先级、严重程度          |
| REQ-ISSUE-003 | 问题分配 | 高     | 指派处理人                      |
| REQ-ISSUE-004 | 状态追踪 | 高     | 新建 → 处理中 → 已解决 → 已关闭 |
| REQ-ISSUE-005 | 高级搜索 | 中     | 多条件组合搜索过滤              |

**Wiki 知识库功能**：

| 需求编号     | 功能     | 优先级 | 说明               |
| ------------ | -------- | ------ | ------------------ |
| REQ-WIKI-001 | 页面创建 | 高     | Markdown 格式编辑  |
| REQ-WIKI-002 | 页面链接 | 中     | 快捷导航链接管理   |
| REQ-WIKI-003 | 版本历史 | 中     | 查看和回滚历史版本 |
| REQ-WIKI-004 | 附件管理 | 中     | 上传和预览附件     |

#### (5) 统计报表与第三方集成模块

**统计报表功能**：

| 需求编号     | 功能     | 优先级 | 说明              |
| ------------ | -------- | ------ | ----------------- |
| REQ-STAT-001 | 燃尽图   | 高     | Sprint 进度可视化 |
| REQ-STAT-002 | 累积流图 | 中     | 工作分布趋势分析  |
| REQ-STAT-003 | 速度图   | 中     | 团队产能历史追踪  |
| REQ-STAT-004 | 数据导出 | 中     | CSV/JSON 格式导出 |

**第三方集成功能**：

| 需求编号    | 功能           | 优先级 | 说明                    |
| ----------- | -------------- | ------ | ----------------------- |
| REQ-INT-001 | GitHub Webhook | 中     | 代码提交关联任务        |
| REQ-INT-002 | GitLab Webhook | 中     | 代码提交关联任务        |
| REQ-INT-003 | Slack 通知     | 低     | 推送项目事件到 Slack    |
| REQ-INT-004 | 数据导入       | 中     | 从 Trello/Jira 导入项目 |

---

### 2.3 系统数据建模 (E-R 图)

系统数据模型包含三种互相关联的信息：数据对象、数据对象的属性和数据对象彼此间相互连接的关系。本项目使用实体-联系图来清晰、准确地描述用户的数据要求。E-R 图属于面向问题的数据模型，即概念性数据模型。它从用户角度出发看待数据，反映用户的现实环境，与软件系统中的实现方法无关。

本节使用实体-关系图 (Entity-Relationship Diagram) 描述系统核心数据结构。全局的 E-R 图设计如图 2.1 所示，对全局 E-R 图进行分解，得到图 2.2 至图 2.5 所示的局部 E-R 图。

#### 图 2.1 全局 E-R 图

全局 E-R 图展示本系统中所有核心实体及其关联关系。

**核心实体**：

- **User**: 用户
- **Project**: 项目
- **UserStory**: 用户故事
- **Task**: 任务
- **Milestone**: 冲刺/里程碑
- **Issue**: 问题
- **Epic**: 史诗
- **WikiPage**: Wiki 页面
- **Role**: 角色

**核心关系**：

- User ↔ Project: 通过 Membership 多对多关联
- Project → 其他实体: 一对多包含关系
- UserStory → Task: 一对多分解关系
- Epic ↔ UserStory: 多对多关联关系

![全局E-R图](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch2/2_1_global_er.png)

#### 图 2.2 用户与项目成员关系局部 E-R 图

详细描述用户、项目、成员关系和角色之间的关联。

| 实体/关系  | 说明                             |
| ---------- | -------------------------------- |
| User       | 系统用户，可参与多个项目         |
| Project    | 项目容器，有一个所有者           |
| Membership | 成员关系，记录用户在项目中的角色 |
| Role       | 角色定义，包含权限列表           |

**关系基数**：

- User : Membership = 1 : n (一个用户可加入多个项目)
- Project : Membership = 1 : n (一个项目可有多个成员)
- Membership : Role = n : 1 (每个成员关系对应一个角色)

![用户与项目成员关系E-R图](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch2/2_2_user_project_er.png)

#### 图 2.3 史诗、用户故事与任务层级关系局部 E-R 图

描述敏捷开发中的工作分解层级结构。

**层级关系**：

```
Epic (史诗)
  └── n:m ── UserStory (用户故事)
               ├── n:1 ── Milestone (冲刺)
               └── 1:n ── Task (任务)
```

**关键字段**：

- `RelatedUserStory`: Epic 与 UserStory 的多对多关联表
- `milestone_id`: UserStory 所属的冲刺
- `user_story_id`: Task 所属的用户故事

![史诗用户故事任务层级E-R图](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch2/2_3_epic_us_task_er.png)

#### 图 2.4 看板、泳道与状态流转局部 E-R 图

描述 Kanban 模式下的状态管理结构。

| 实体                    | 说明                               |
| ----------------------- | ---------------------------------- |
| Swimlane                | 泳道，按类别或负责人分组           |
| UserStoryStatus         | 用户故事状态，定义看板列           |
| SwimlaneUserStoryStatus | 泳道-状态配置，可单独设置 WIP 限制 |

**WIP 限制**：

- 全局 WIP: 在 `UserStoryStatus.wip_limit` 设置
- 泳道 WIP: 在 `SwimlaneUserStoryStatus.wip_limit` 覆盖

![看板泳道状态E-R图](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch2/2_4_kanban_er.png)

#### 图 2.5 问题追踪与附件管理局部 E-R 图

描述问题追踪模块的数据结构及通用附件机制。

**Issue 关联实体**：

- `IssueStatus`: 问题状态 (新建/处理中/已解决/已关闭)
- `IssueType`: 问题类型 (Bug/增强/问题等)
- `Priority`: 优先级 (低/普通/高/紧急)
- `Severity`: 严重程度 (愿望/轻微/正常/重要/致命)

**通用附件机制**：

- 使用 Django `GenericRelation` 实现
- `Attachment.content_type` + `Attachment.object_id` 关联任意实体
- 支持 UserStory、Task、Issue、WikiPage 等附件

![问题追踪与附件E-R图](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch2/2_5_issue_attachment_er.png)

---

### 2.4 系统功能建模

如下图 2.6 顶层数据流图所示，该系统整体上可以分为三个实体和一个处理过程。其实体分别为普通用户、项目管理员、系统管理员，处理过程为敏捷项目管理平台。该数据流图以人机交互思想为指导，从整体观念出发，展示了流入和流出系统的所有数据信息。

#### 图 2.6 系统用例图 (Use Case Diagram)

用例图展示系统参与者与功能用例之间的交互关系。

**参与者 (Actors)**：

| 参与者     | 说明                       |
| ---------- | -------------------------- |
| 普通用户   | 项目团队成员，使用核心功能 |
| 项目管理员 | 项目负责人，可配置项目设置 |
| 系统管理员 | 平台运维人员，拥有最高权限 |
| 外部系统   | GitHub/GitLab 等第三方平台 |

**核心用例分组**：

| 分组     | 用例                                              |
| -------- | ------------------------------------------------- |
| 认证模块 | 用户注册、用户登录、修改个人资料                  |
| 项目管理 | 创建项目、邀请成员、配置角色权限                  |
| Scrum    | 管理用户故事、规划 Sprint、分解任务、更新任务状态 |
| Kanban   | 配置看板、管理泳道、拖拽卡片                      |
| 问题追踪 | 创建问题、处理问题                                |
| Wiki     | 编辑 Wiki 页面                                    |
| 统计     | 查看燃尽图、导出数据                              |
| 管理     | 系统配置、用户管理                                |
| 集成     | 接收 Webhook                                      |

![系统用例图](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch2/2_6_use_case.png)

#### 图 2.7 功能层次图

功能层次图采用自顶向下的结构分解系统功能。

**一级模块划分**：

| 模块     | 对应 API 路径                                                | 说明                    |
| -------- | ------------------------------------------------------------ | ----------------------- |
| 用户认证 | `/api/v1/auth`, `/api/v1/users`                              | 注册、登录、Token 管理  |
| 项目管理 | `/api/v1/projects`                                           | 项目 CRUD、成员管理     |
| 敏捷管理 | `/api/v1/userstories`, `/api/v1/tasks`, `/api/v1/milestones` | Backlog、Sprint、Kanban |
| 问题追踪 | `/api/v1/issues`                                             | Issue 全生命周期        |
| 知识库   | `/api/v1/wiki`                                               | Wiki 页面管理           |
| 统计报表 | `/api/v1/projects/{id}/stats`                                | 燃尽图、速度图          |
| 系统集成 | `/api/v1/webhooks`                                           | Webhook、数据导入       |

**功能分解层级**：

```
本系统
├── 用户认证
│   ├── 用户注册
│   └── 用户登录
├── 项目管理
│   ├── 创建项目
│   └── 成员管理
├── 敏捷管理
│   ├── Backlog
│   │   ├── 故事创建
│   │   └── 故事排序
│   ├── Sprint
│   │   ├── 创建冲刺
│   │   └── 任务分解
│   └── Kanban
├── 问题追踪
│   ├── 问题创建
│   └── 问题处理
├── 知识库
│   ├── Wiki编辑
│   └── 版本管理
├── 统计报表
│   ├── 燃尽图
│   └── 速度图
└── 系统集成
    ├── Webhook
    └── 数据导入
```

![功能层次图](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch2/2_7_function_hierarchy.png)

---

### 2.5 完善的数据字典

数据字典最重要的用途是作为分析阶段的工具。典型的情况是，在数据字典中记录数据元素的下列信息：一般信息（名称、描述）、定义（数据类型、长度、结构等）、使用特点（值的范围、使用频率、使用方式---输入、输出、本地、条件值等）、控制信息（来源、用户、使用它的程序、改变权、使用权等）等。

本节对 1.2.3 节的数据字典进行补充，增加系统运行相关的扩展实体定义。根据可行性分析研究阶段得到的数据字典进行补充完善如下：

#### 表 2.10 Webhook 数据字典

**用途**: 存储项目 Webhook 配置，用于与外部系统集成

| 字段名            | 数据类型     | 约束                  | 说明         |
| ----------------- | ------------ | --------------------- | ------------ |
| id                | INTEGER      | PK, AUTO              | 主键         |
| project_id        | INTEGER      | FK → projects_project | 所属项目     |
| name              | VARCHAR(250) | NOT NULL              | Webhook 名称 |
| url               | VARCHAR(500) | NOT NULL              | 回调 URL     |
| key               | VARCHAR(250) | NOT NULL              | 验证密钥     |
| logs_days_to_keep | INTEGER      | NOT NULL              | 日志保留天数 |

#### 表 2.11 Webhook 日志数据字典

| 字段名        | 数据类型     | 约束                  | 说明          |
| ------------- | ------------ | --------------------- | ------------- |
| id            | INTEGER      | PK, AUTO              | 主键          |
| webhook_id    | INTEGER      | FK → webhooks_webhook | 所属 Webhook  |
| url           | VARCHAR(500) | NOT NULL              | 请求 URL      |
| status        | INTEGER      | NOT NULL              | HTTP 状态码   |
| request_data  | TEXT         | NULL                  | 请求数据      |
| response_data | TEXT         | NULL                  | 响应数据      |
| created       | TIMESTAMP    | NOT NULL              | 创建时间      |
| duration      | DECIMAL      | NULL                  | 请求耗时 (秒) |

#### 表 2.12 认证令牌数据字典

**用途**: 扩展 JWT 令牌管理

| 字段名  | 数据类型     | 约束            | 说明     |
| ------- | ------------ | --------------- | -------- |
| id      | INTEGER      | PK, AUTO        | 主键     |
| user_id | INTEGER      | FK → users_user | 所属用户 |
| token   | VARCHAR(200) | UNIQUE          | 令牌值   |
| created | TIMESTAMP    | NOT NULL        | 创建时间 |
| expired | TIMESTAMP    | NULL            | 过期时间 |

#### 表 2.13 通知策略数据字典

**用途**: 用户针对每个项目的通知偏好设置

| 字段名            | 数据类型 | 约束                  | 说明                                   |
| ----------------- | -------- | --------------------- | -------------------------------------- |
| id                | INTEGER  | PK, AUTO              | 主键                                   |
| project_id        | INTEGER  | FK → projects_project | 所属项目                               |
| user_id           | INTEGER  | FK → users_user       | 所属用户                               |
| notify_level      | INTEGER  | NOT NULL              | 通知级别 (0=无/1=仅我/2=仅观察/3=全部) |
| live_notify_level | INTEGER  | NOT NULL              | 实时通知级别                           |
| web_notify_level  | BOOLEAN  | NOT NULL              | 是否 Web 通知                          |

#### 表 2.14 历史快照数据字典

**用途**: 记录实体变更历史，支持活动流和审计

| 字段名     | 数据类型     | 约束                  | 说明                          |
| ---------- | ------------ | --------------------- | ----------------------------- |
| id         | UUID         | PK                    | 主键                          |
| user_id    | INTEGER      | FK → users_user       | 操作用户                      |
| project_id | INTEGER      | FK → projects_project | 所属项目                      |
| key        | VARCHAR(255) | NOT NULL              | 实体标识 (如 `userstory:123`) |
| type       | INTEGER      | NOT NULL              | 变更类型 (创建/修改/删除)     |
| snapshot   | JSONB        | NULL                  | 变更后快照                    |
| diff       | JSONB        | NULL                  | 变更差异                      |
| values     | JSONB        | NULL                  | 额外值                        |
| comment    | TEXT         | NULL                  | 变更备注                      |
| created_at | TIMESTAMP    | NOT NULL              | 创建时间                      |

#### 表 2.15 附件数据字典 (扩展)

**用途**: 通用附件存储 (使用 GenericForeignKey)

| 字段名          | 数据类型     | 约束                     | 说明            |
| --------------- | ------------ | ------------------------ | --------------- |
| id              | INTEGER      | PK, AUTO                 | 主键            |
| owner_id        | INTEGER      | FK → users_user          | 上传者          |
| project_id      | INTEGER      | FK → projects_project    | 所属项目        |
| content_type_id | INTEGER      | FK → django_content_type | 关联实体类型    |
| object_id       | INTEGER      | NOT NULL                 | 关联实体 ID     |
| name            | VARCHAR(500) | NOT NULL                 | 文件名          |
| size            | BIGINT       | NULL                     | 文件大小 (字节) |
| attached_file   | VARCHAR(500) | NOT NULL                 | 存储路径        |
| is_deprecated   | BOOLEAN      | NOT NULL                 | 是否已废弃      |
| from_comment    | BOOLEAN      | NOT NULL                 | 是否来自评论    |
| created_date    | TIMESTAMP    | NOT NULL                 | 创建时间        |
| modified_date   | TIMESTAMP    | NOT NULL                 | 修改时间        |
| sha1            | VARCHAR(40)  | NULL                     | 文件 SHA1 校验  |

#### 数据字典汇总

| 表编号 | 表名                             | 实体         | 章节  |
| ------ | -------------------------------- | ------------ | ----- |
| 1.1    | users_user                       | 用户         | 1.2.3 |
| 1.2    | projects_project                 | 项目         | 1.2.3 |
| 1.3    | userstories_userstory            | 用户故事     | 1.2.3 |
| 1.4    | tasks_task                       | 任务         | 1.2.3 |
| 1.5    | milestones_milestone             | 冲刺         | 1.2.3 |
| 1.6    | issues_issue                     | 问题         | 1.2.3 |
| 1.7    | epics_epic                       | 史诗         | 1.2.3 |
| 1.8    | projects_membership / users_role | 成员/角色    | 1.2.3 |
| 1.9    | wiki_wikipage / wiki_wikilink    | Wiki         | 1.2.3 |
| 2.10   | webhooks_webhook                 | Webhook      | 2.5   |
| 2.11   | webhooks_webhooklog              | Webhook 日志 | 2.5   |
| 2.12   | custom_token                     | 认证令牌     | 2.5   |
| 2.13   | notifications_notifypolicy       | 通知策略     | 2.5   |
| 2.14   | history_historyentry             | 历史快照     | 2.5   |
| 2.15   | attachments_attachment           | 附件         | 2.5   |

---

## 第 3 章 总体设计

本章将对敏捷项目管理平台进行总体设计，主要包括系统结构图、数据库设计和模块 IPO 表三个部分。系统结构图展示了系统的整体架构和模块划分；数据库设计包括逻辑结构设计和物理结构设计；模块 IPO 表则详细描述了各主要模块的输入、处理和输出。

### 3.1 系统结构图

本节给出本系统的总体结构图，包括前后端分离架构图、后端模块依赖图和前端模块依赖图。

#### 3.1.0 架构升级规划：Monolith 到 Microservices

根据项目需求，计划将 Taiga 单体架构升级为微服务架构，采用以下设计模式：

**1. Strangler Fig (绞杀榕) 模式**

逐步替换旧系统，新功能使用微服务实现，旧功能按需迁移：

```
[前端应用]
     │
     ▼
[API 网关] ──────────────────────────────────┐
     │                                        │
     ├──▶ [新微服务] ◀── 新功能               │
     │      ├── 用户服务                      │
     │      ├── 项目服务                      │
     │      └── 通知服务                      │
     │                                        │
     └──▶ [Taiga 单体] ◀── 旧功能逐步迁移 ────┘
```

**2. 领域驱动设计 (DDD) 服务划分**

| 领域   | 微服务               | 职责                    |
| ------ | -------------------- | ----------------------- |
| 用户域 | user-service         | 认证、授权、个人资料    |
| 项目域 | project-service      | 项目管理、成员、角色    |
| 敏捷域 | agile-service        | Backlog、Sprint、Kanban |
| 问题域 | issue-service        | Bug 追踪、问题管理      |
| 知识域 | wiki-service         | Wiki 页面、附件         |
| 通知域 | notification-service | 邮件、WebSocket 推送    |

**3. 技术栈升级路径**

| 组件     | 原 Taiga 版本 | 本系统（Tenzu 架构） |
| -------- | ------------- | -------------------- |
| 后端框架 | Django 3.2    | Django 5.2           |
| API 框架 | DRF           | Django-Ninja         |
| 前端框架 | AngularJS 1.5 | Angular 21           |
| 容器化   | Docker        | Kubernetes           |
| API 网关 | 无            | Kong/Nginx           |

#### 图 3.1 前后端分离架构图

本系统采用前后端分离的 SPA (Single Page Application) 架构。

**架构层次**：

| 层次   | 技术栈                  | 职责               |
| ------ | ----------------------- | ------------------ |
| 前端层 | Angular 21 + TypeScript | 用户界面、交互逻辑 |
| API 层 | Django-Ninja            | RESTful API 服务   |
| 业务层 | Django + Celery         | 业务逻辑、异步任务 |
| 数据层 | PostgreSQL + Redis      | 持久化存储、缓存   |

**通信协议**：

- 前端 ↔ 后端: HTTP/HTTPS + JSON
- 实时通信: WebSocket (taiga-events)
- 外部集成: Webhook 回调

![前后端分离架构图](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch3/3_1_architecture.png)

#### 图 3.2 后端 Django 应用模块依赖图

后端采用 Django 应用模块化设计，核心模块采用模块化设计。

**核心模块**：

- `auth`: 用户认证与 JWT Token 管理
- `users`: 用户模型与个人资料
- `projects`: 项目管理核心 (包含子模块)
- `base`: 基础类与通用工具
- `permissions`: 权限控制系统
- `events`: 实时事件推送

**projects 子模块**：

- `userstories`: 用户故事管理
- `tasks`: 任务管理
- `milestones`: 冲刺/里程碑
- `issues`: 问题追踪
- `epics`: 史诗管理
- `wiki`: 知识库

![后端模块依赖图](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch3/3_2_backend_modules.png)

#### 图 3.3 前端 Angular 模块依赖图

前端采用 Angular 模块化组织，模块在 `app/modules/` 目录下。

**功能模块**（参考 Taiga/Tenzu 架构）：

- `taiga.auth`: 登录/注册页面
- `taiga.home`: 主页/仪表盘
- `taiga.projects`: 项目列表/详情
- `taiga.backlog`: Backlog 管理
- `taiga.kanban`: 看板视图
- `taiga.taskboard`: 任务板视图
- `taiga.issues`: 问题列表
- `taiga.wiki`: Wiki 编辑器

**公共模块**：

- `taiga.common`: 通用指令/过滤器
- `taiga.components`: 可复用组件
- `taiga.services`: HTTP 服务封装
- `taiga.resources`: API 资源定义
- `taiga.events`: WebSocket 事件处理

![前端模块依赖图](https://raw.githubusercontent.com/TreeAWater/software_project/main/%E6%9C%80%E7%BB%88%E6%96%87%E6%A1%A3/drawio/ch3/3_3_frontend_modules.png)

---

### 3.2 数据库设计

本节对本系统的数据库进行详细设计，包括逻辑结构设计和物理结构设计两个部分。逻辑结构设计主要描述数据库表结构和表之间的关系；物理结构设计主要描述索引策略、存储优化和性能配置。

#### 3.2.1 逻辑结构设计

根据上一章的 E-R 图分析，将实体-关系模型转换为关系模型，得到以下数据库表设计：

##### (1) 核心业务表设计

| 表名                  | 实体     | 核心字段                              | 关联                            |
| --------------------- | -------- | ------------------------------------- | ------------------------------- |
| userstories_userstory | 用户故事 | ref, subject, status_id, milestone_id | Project, Milestone, Status      |
| tasks_task            | 任务     | ref, subject, user_story_id           | UserStory, Milestone            |
| issues_issue          | 问题     | ref, subject, type_id, priority_id    | Project, Status, Type, Priority |

**设计特点**：

- 使用 `ref` 字段作为项目内唯一编号 (如 #123)
- 状态通过外键关联到状态配置表
- 支持 `is_blocked` 标记阻塞状态

##### (2) 项目配置表设计

| 表名                     | 用途         | 核心字段                          |
| ------------------------ | ------------ | --------------------------------- |
| projects_points          | 故事点定义   | name, value, order                |
| projects_userstorystatus | 用户故事状态 | name, color, is_closed, wip_limit |
| projects_taskstatus      | 任务状态     | name, color, is_closed            |
| projects_swimlane        | 泳道         | name, order                       |

##### (3) 辅助功能表设计

| 表名                       | 用途     | 说明                             |
| -------------------------- | -------- | -------------------------------- |
| history_historyentry       | 变更历史 | 记录所有实体的创建/修改/删除操作 |
| notifications_notifypolicy | 通知策略 | 用户针对项目的通知偏好           |
| likes_like / votes_vote    | 投票点赞 | 通用投票机制                     |

#### 3.2.2 物理结构设计

##### (1) 索引策略与全文检索

**常用索引**：

```sql
-- 项目内引用编号查询
CREATE INDEX idx_userstory_ref ON userstories_userstory(ref);
CREATE INDEX idx_task_ref ON tasks_task(ref);
CREATE INDEX idx_issue_ref ON issues_issue(ref);

-- 状态筛选
CREATE INDEX idx_userstory_status ON userstories_userstory(status_id);
CREATE INDEX idx_task_status ON tasks_task(status_id);

-- 冲刺内排序
CREATE INDEX idx_userstory_sprint_order ON userstories_userstory(milestone_id, sprint_order);
```

**全文检索**：

- PostgreSQL 内置 `tsvector` 全文索引
- 搜索范围: subject, description 字段
- 支持中文需配置 `pg_jieba` 分词插件

##### (2) JSONB 字段存储策略

本系统使用 JSONB 存储可扩展数据：

| 使用场景   | 字段                     | 说明               |
| ---------- | ------------------------ | ------------------ |
| 自定义属性 | custom_attributes_values | 用户自定义字段值   |
| 历史快照   | snapshot                 | 变更前后的完整状态 |
| 变更差异   | diff                     | 字段级别变更记录   |
| 扩展数据   | extra                    | 第三方集成附加数据 |

---

### 3.3 系统模块 IPO 表 (输入-处理-输出)

IPO 表（输入-处理-输出表）是描述系统各模块功能的有效工具。通过 IPO 表可以清晰地了解每个模块的输入数据、处理逻辑和输出结果。本节给出本系统主要模块的 IPO 表，包括用户认证、项目管理、敏捷管理等核心模块。

#### 3.3.1 用户注册与 JWT 认证模块

| 项目       | 内容                                                                |
| ---------- | ------------------------------------------------------------------- |
| **模块名** | AuthViewSet                                                         |
| **输入**   | username, email, password, accepted_terms                           |
| **处理**   | 1. 验证用户名/邮箱唯一性<br>2. 密码加密存储<br>3. 生成 JWT Token 对 |
| **输出**   | { access_token, refresh_token, user_info }                          |

#### 3.3.2 项目创建与模板初始化模块

| 项目       | 内容                                                                        |
| ---------- | --------------------------------------------------------------------------- |
| **模块名** | ProjectViewSet.create                                                       |
| **输入**   | name, description, is_private, creation_template                            |
| **处理**   | 1. 创建项目记录<br>2. 根据模板初始化状态/点数/角色<br>3. 添加创建者为管理员 |
| **输出**   | 完整项目对象 (含配置)                                                       |

#### 3.3.3 Backlog 待办事项排序与管理模块

| 项目       | 内容                                                            |
| ---------- | --------------------------------------------------------------- |
| **模块名** | userstories/services                                            |
| **输入**   | project_id, userstory_ids, before_id/after_id                   |
| **处理**   | 1. 计算新排序值<br>2. 批量更新 backlog_order<br>3. 触发历史记录 |
| **输出**   | 更新后的用户故事列表                                            |

#### 3.3.4 Sprint 冲刺创建与任务分配模块

| 项目       | 内容                                                                   |
| ---------- | ---------------------------------------------------------------------- |
| **模块名** | MilestoneViewSet, userstories/services                                 |
| **输入**   | name, estimated_start, estimated_finish, userstory_ids                 |
| **处理**   | 1. 创建 Milestone<br>2. 关联用户故事<br>3. 同步更新任务的 milestone_id |
| **输出**   | Milestone 及关联故事                                                   |

#### 3.3.5 Kanban 状态拖拽与变更模块

| 项目       | 内容                                                                                  |
| ---------- | ------------------------------------------------------------------------------------- |
| **模块名** | userstories/services                                                                  |
| **输入**   | userstory_id, new_status_id, new_swimlane_id, before_id/after_id                      |
| **处理**   | 1. 验证 WIP 限制<br>2. 更新状态/泳道<br>3. 更新 kanban_order<br>4. 重新计算 is_closed |
| **输出**   | 更新后的用户故事                                                                      |

#### 3.3.6 任务 (Task) 增删改查模块

| 项目         | 内容                                              |
| ------------ | ------------------------------------------------- |
| **模块名**   | TaskViewSet                                       |
| **输入**     | user_story_id, subject, assigned_to_id, status_id |
| **处理**     | 1. CRUD 操作<br>2. 更新排序<br>3. 触发历史/通知   |
| **输出**     | Task 对象                                         |
| **API 路径** | `/api/v1/tasks/`                                  |

#### 3.3.7 问题 (Issue) 报告与过滤器模块

| 项目         | 内容                                                         |
| ------------ | ------------------------------------------------------------ |
| **模块名**   | IssueViewSet                                                 |
| **输入**     | subject, type_id, priority_id, severity_id, filters          |
| **处理**     | 1. 创建/更新 Issue<br>2. 多条件过滤查询<br>3. 自定义属性处理 |
| **输出**     | 分页 Issue 列表                                              |
| **支持过滤** | status, type, priority, severity, assigned_to, tags          |

#### 3.3.8 Wiki 页面版本控制与渲染模块

| 项目       | 内容                                                |
| ---------- | --------------------------------------------------- |
| **模块名** | WikiViewSet                                         |
| **输入**   | slug, content (Markdown)                            |
| **处理**   | 1. 保存页面内容<br>2. 版本号递增<br>3. 记录历史快照 |
| **输出**   | WikiPage 对象 (含版本)                              |
| **渲染**   | Markdown → HTML (前端处理)                          |

#### 3.3.9 团队成员邀请与角色配置模块

| 项目       | 内容                                                               |
| ---------- | ------------------------------------------------------------------ |
| **模块名** | MembershipViewSet                                                  |
| **输入**   | project_id, email, role_id                                         |
| **处理**   | 1. 生成邀请令牌<br>2. 发送邀请邮件<br>3. 接受邀请后创建 Membership |
| **输出**   | Membership 对象                                                    |

#### 3.3.10 实时通知与邮件发送模块

| 项目            | 内容                                                                     |
| --------------- | ------------------------------------------------------------------------ |
| **模块名**      | events, notifications                                                    |
| **输入**        | user_ids, event_type, data                                               |
| **处理**        | 1. 检查用户通知策略<br>2. WebSocket 实时推送<br>3. 异步邮件发送 (Celery) |
| **输出**        | 通知状态                                                                 |
| **Celery 任务** | `send_notification_email.delay()`                                        |

---

## 第 4 章 详细设计

本章将对本系统各功能模块进行详细设计。详细设计是在总体设计的基础上，对每个模块的内部处理逻辑进行具体描述，包括模块的输入输出、处理流程、算法设计和接口定义等。本章共分为 9 个小节，分别对应系统的主要功能模块。

### 4.1 用户认证与个人中心模块

本模块负责用户的注册、登录、认证和个人信息管理功能。基于 JWT (JSON Web Token) 机制实现无状态认证，支持多种登录方式和第三方 OAuth 集成。

#### 4.1.1 登录/注册逻辑 (Token 机制)

**认证流程**：

```
用户注册:
  1. POST /api/v1/auth/register (username, email, password)
  2. 验证用户名/邮箱唯一性
  3. 创建 User 记录 (密码 bcrypt 加密)
  4. 返回 JWT Token 对

用户登录:
  1. POST /api/v1/auth (username/email, password)
  2. 验证凭据
  3. 生成 Access Token (有效期 1h) + Refresh Token (有效期 7d)
  4. 返回 Token 和用户信息
```

**Token 刷新机制**：

- Access Token 过期后，使用 Refresh Token 换取新 Token
- Refresh Token 一次性使用，换取后即失效

#### 4.1.2 个人资料与头像管理

| 功能     | API                                   | 说明                         |
| -------- | ------------------------------------- | ---------------------------- |
| 获取资料 | GET /api/v1/users/me                  | 返回当前用户详情             |
| 更新资料 | PATCH /api/v1/users/{id}              | 修改 full_name, bio, lang 等 |
| 上传头像 | POST /api/v1/users/{id}/change_avatar | 支持 jpg/png，自动生成缩略图 |

#### 4.1.3 密码重置与邮箱验证

**密码重置流程**：

1. 用户提交邮箱 → 生成 reset_token
2. 发送含重置链接的邮件
3. 用户访问链接 → 验证 token 有效性
4. 提交新密码 → 更新密码哈希

---

### 4.2 项目管理核心模块

#### 4.2.1 项目创建向导 (Scrum/Kanban/导入)

**项目模板**：

| 模板   | 启用模块                   | 预设配置                     |
| ------ | -------------------------- | ---------------------------- |
| Scrum  | Backlog, Sprint, Taskboard | 标准故事点 (?, 0, 1/2, 1-21) |
| Kanban | Kanban, Issues             | 默认泳道 + WIP 限制          |
| 空白   | 无                         | 用户自定义                   |

#### 4.2.2 项目配置 (模块启用/禁用)

```python
# 可配置模块
is_backlog_activated = models.BooleanField(default=True)
is_kanban_activated = models.BooleanField(default=False)
is_wiki_activated = models.BooleanField(default=True)
is_issues_activated = models.BooleanField(default=True)
is_epics_activated = models.BooleanField(default=False)
```

#### 4.2.3 成员管理与权限控制 (ACL)

**权限模型**：

- 项目角色 (Role) 定义权限列表
- Membership 关联 User ↔ Project ↔ Role
- 权限检查使用 DRF Permission 类

**常用权限**：

- `view_project`, `modify_project`, `delete_project`
- `view_us`, `add_us`, `modify_us`, `delete_us`
- `view_tasks`, `add_task`, `modify_task`
- `admin_project_values` (管理员权限)

---

### 4.3 待办事项 (Backlog) 模块

#### 4.3.1 用户故事创建与估点 (Points)

**故事点系统**：

- 使用 Fibonacci 序列: ?, 0, 1/2, 1, 2, 3, 5, 8, 13, 21, 40, 100
- 支持多角色估点 (RolePoints 中间表)
- 自动聚合计算总点数

#### 4.3.2 拖拽排序算法设计

```python
def calculate_new_order(before_order, after_order):
    """计算拖拽后的新排序值"""
    if before_order is None:
        return after_order - 1000000  # 移动到最前
    if after_order is None:
        return before_order + 1000000  # 移动到最后
    return (before_order + after_order) // 2  # 插入中间
```

#### 4.3.3 批量操作与状态变更

| 批量操作       | API                                                | 参数                 |
| -------------- | -------------------------------------------------- | -------------------- |
| 批量修改状态   | POST /api/v1/userstories/bulk_update_backlog_order | us_ids, status_id    |
| 批量移动到冲刺 | POST /api/v1/userstories/bulk_update_milestone     | us_ids, milestone_id |
| 批量分配负责人 | PATCH (多次)                                       | assigned_to_id       |

---

### 4.4 冲刺 (Sprint) 管理模块

#### 4.4.1 冲刺周期规划与启动

**冲刺生命周期**：

1. **规划中**: 创建冲刺，设置时间范围
2. **进行中**: 分配用户故事，开始开发
3. **回顾**: 查看完成度，生成报告
4. **关闭**: 标记 closed=True

#### 4.4.2 任务板 (Taskboard) 设计

**任务板结构**：

```
┌─────────────────────────────────────────────────────────┐
│ Sprint: Sprint 1 (2025-01-06 ~ 2025-01-20)              │
├─────────────────────────────────────────────────────────┤
│ US-01: 用户登录                                         │
│  ├─ [新建] Task 1   [进行中] Task 2   [已完成] Task 3   │
├─────────────────────────────────────────────────────────┤
│ US-02: 看板视图                                         │
│  ├─ [新建] Task 4   [新建] Task 5                       │
└─────────────────────────────────────────────────────────┘
```

#### 4.4.3 燃尽图 (Burndown Chart) 计算逻辑

```python
def calculate_burndown(milestone):
    """计算冲刺燃尽数据"""
    total_points = sum(us.total_points for us in milestone.user_stories.all())
    data = []
    for date in date_range(milestone.estimated_start, milestone.estimated_finish):
        closed_points = sum(
            us.total_points for us in milestone.user_stories.filter(
                is_closed=True, finish_date__lte=date
            )
        )
        data.append({
            "date": date,
            "remaining": total_points - closed_points,
            "ideal": calculate_ideal(total_points, date)
        })
    return data
```

---

### 4.5 看板 (Kanban) 模块

#### 4.5.1 泳道 (Swimlane) 设计

**泳道类型**：

- 按负责人分组
- 按标签分组
- 按自定义字段分组
- 无泳道 (平铺)

#### 4.5.2 列状态 (Status) 管理与 WIP 限制

| 状态配置 | 字段      | 说明                   |
| -------- | --------- | ---------------------- |
| 名称     | name      | 显示在看板列头         |
| 颜色     | color     | 十六进制颜色值         |
| WIP 限制 | wip_limit | 0=无限制               |
| 是否关闭 | is_closed | 进入此状态时标记为关闭 |

#### 4.5.3 卡片快速编辑与过滤

**过滤器支持**：

- 负责人 (`assigned_to`)
- 标签 (`tags`)
- 状态 (`status`)
- 泳道 (`swimlane`)
- 自定义属性 (`custom_attributes`)

---

### 4.6 史诗 (Epic) 管理模块

#### 4.6.1 史诗创建与颜色管理

```python
class Epic(models.Model):
    subject = models.TextField()
    color = models.CharField(max_length=9, default="#999999")
    # 颜色用于在看板和 Backlog 中标识关联的用户故事
```

#### 4.6.2 关联用户故事与进度聚合

**进度计算**：

```python
def get_progress(epic):
    related_stories = epic.user_stories.all()
    total = related_stories.count()
    closed = related_stories.filter(is_closed=True).count()
    return {"total": total, "closed": closed, "percent": closed/total * 100}
```

---

### 4.7 问题追踪 (Issue) 模块

#### 4.7.1 问题分类、优先级与严重程度管理

| 维度     | 预设值                       | 可自定义 |
| -------- | ---------------------------- | -------- |
| 类型     | Bug, 问题, 增强              | ✓        |
| 优先级   | 低, 普通, 高, 紧急           | ✓        |
| 严重程度 | 愿望, 轻微, 正常, 重要, 致命 | ✓        |

#### 4.7.2 高级搜索与过滤器逻辑

```python
# 过滤器查询构建
queryset = Issue.objects.filter(project=project)
if status_id:
    queryset = queryset.filter(status_id=status_id)
if type_id:
    queryset = queryset.filter(type_id=type_id)
if assigned_to_id:
    queryset = queryset.filter(assigned_to_id=assigned_to_id)
if tags:
    queryset = queryset.filter(tags__contains=tags)
```

---

### 4.8 Wiki 与知识库模块

#### 4.8.1 Markdown 渲染与编辑器集成

**支持语法**：

- 标准 Markdown
- GitHub Flavored Markdown (表格、代码块)
- 任务列表 `- [ ]`
- Mermaid 图表 (前端渲染)

#### 4.8.2 页面层级结构与链接管理

| 实体     | 用途                     |
| -------- | ------------------------ |
| WikiPage | 页面内容 (slug 作为 URL) |
| WikiLink | 快捷链接导航             |

#### 4.8.3 历史版本回滚机制

- 每次保存创建 HistoryEntry 快照
- 支持查看任意历史版本
- 支持回滚到指定版本

---

### 4.9 辅助功能模块

#### 4.9.1 附件上传与预览 (Attachments)

**支持类型**：

- 图片: jpg, png, gif, svg
- 文档: pdf, doc, xls
- 其他: zip, tar.gz

**存储结构**：

```
/media/attachments/project-{id}/userstory/{us_id}/{filename}
```

#### 4.9.2 活动日志与时间线 (Timeline)

**记录事件**：

- 实体创建/修改/删除
- 状态变更
- 评论添加
- 附件上传

#### 4.9.3 投票 (Upvote) 与关注 (Watch) 机制

| 功能 | 表                    | 作用           |
| ---- | --------------------- | -------------- |
| 投票 | votes_vote            | 优先级排序参考 |
| 关注 | notifications_watched | 接收变更通知   |

#### 4.9.4 Webhook 集成与测试

**Webhook 事件类型**：

- `userstory.create`, `userstory.change`, `userstory.delete`
- `task.create`, `task.change`, `task.delete`
- `issue.create`, `issue.change`, `issue.delete`
- `milestone.create`, `milestone.change`

---

## 第 5 章 系统实现

本章将详细介绍本系统的实现过程，包括开发环境配置、核心编码实现、各模块功能实现以及关键算法实现四个部分。通过具体的代码示例展示系统的实现细节。

### 5.1 开发平台和开发环境介绍

本节介绍本项目的开发平台和开发环境配置。本项目采用 Tenzu 架构，将 Taiga 的功能迁移到现代技术栈。

#### 本项目开发环境（Tenzu 架构）

| 组件         | 版本    | 用途               |
| ------------ | ------- | ------------------ |
| Python       | 3.12+   | 运行环境           |
| Django       | 5.2 LTS | Web 框架           |
| Django-Ninja | 1.0+    | API 框架 (OpenAPI) |
| PostgreSQL   | 16+     | 主数据库           |
| Redis        | 7+      | 缓存/消息队列      |
| Node.js      | 20+     | 前端构建           |
| Angular      | 21      | 前端框架           |

#### Taiga 开源版参考环境

| 组件                  | 版本       | 用途     |
| --------------------- | ---------- | -------- |
| Python                | 3.10+      | 运行环境 |
| Django                | 3.2.25 LTS | Web 框架 |
| Django REST Framework | 3.14+      | API 框架 |
| PostgreSQL            | 14+        | 主数据库 |
| AngularJS             | 1.5        | 前端框架 |
| CoffeeScript          | 1.10       | 前端语言 |

**开发环境配置**：

```bash
# 创建虚拟环境
conda activate test
pip install -r requirements.txt

# 数据库初始化
python manage.py migrate
python manage.py createsuperuser

# 启动开发服务器
python manage.py runserver 0.0.0.0:8000
```

#### 前端开发环境

| 组件       | 版本  | 用途       |
| ---------- | ----- | ---------- |
| Node.js    | 16+   | 构建环境   |
| TypeScript | 5.0+  | 脚本语言   |
| Angular    | 21    | MVC 框架   |
| Gulp       | 4.0.2 | 构建工具   |
| SASS       | 8.0.0 | CSS 预处理 |

**构建命令**：

```bash
npm install
gulp deploy  # 开发构建
gulp dist    # 生产构建
```

---

### 5.2 核心编码与实现

#### 5.2.1 数据库模型实现 (Models.py)

**用户故事模型示例**：

```python
class UserStory(OCCModelMixin, WatchedModelMixin, BlockedMixin,
                TaggedMixin, DueDateMixin, models.Model):
    ref = models.BigIntegerField(db_index=True, null=True, blank=True)
    project = models.ForeignKey("projects.Project", on_delete=models.CASCADE)
    milestone = models.ForeignKey("milestones.Milestone", null=True,
                                   on_delete=models.SET_NULL)
    owner = models.ForeignKey(settings.AUTH_USER_MODEL, null=True,
                              on_delete=models.SET_NULL)
    status = models.ForeignKey("projects.UserStoryStatus", null=True,
                               on_delete=models.SET_NULL)
    subject = models.TextField()
    description = models.TextField(blank=True)
    is_closed = models.BooleanField(default=False)
    backlog_order = models.BigIntegerField(default=timestamp_mics)
    sprint_order = models.BigIntegerField(default=timestamp_mics)
    kanban_order = models.BigIntegerField(default=timestamp_mics)

    def get_total_points(self):
        return sum(rp.points.value for rp in self.role_points.all()
                   if rp.points.value is not None)
```

#### 5.2.2 REST API 接口实现 (Serializers & ViewSets)

**序列化器示例**：

```python
class UserStorySerializer(WatchedResourceSerializer):
    total_points = serializers.SerializerMethodField()

    class Meta:
        model = UserStory
        fields = ('id', 'ref', 'project', 'milestone', 'subject',
                  'description', 'status', 'is_closed', 'total_points',
                  'backlog_order', 'sprint_order', 'kanban_order')

    def get_total_points(self, obj):
        return obj.get_total_points()
```

**ViewSet 示例**：

```python
class UserStoryViewSet(ModelCrudViewSet):
    queryset = UserStory.objects.all()
    serializer_class = UserStorySerializer
    permission_classes = (permissions.UserStoryPermission,)
    filter_backends = (filters.CanViewUsFilter, filters.OwnersFilter)

    @action(detail=False, methods=['POST'])
    def bulk_update_backlog_order(self, request):
        """批量更新 Backlog 排序"""
        validator = BulkUpdateOrderValidator(data=request.data)
        validator.is_valid(raise_exception=True)
        services.update_userstories_order_in_bulk(
            validator.validated_data
        )
        return Response(status=status.HTTP_204_NO_CONTENT)
```

#### 5.2.3 权限类实现 (Permissions.py)

```python
class UserStoryPermission(TaigaResourcePermission):
    enough_perms = IsProjectAdmin() | IsSuperUser()
    global_perms = None
    retrieve_perms = HasProjectPerm('view_us')
    create_perms = HasProjectPerm('add_us')
    update_perms = HasProjectPerm('modify_us')
    destroy_perms = HasProjectPerm('delete_us')

    def has_object_permission(self, request, view, obj):
        # 检查用户是否有权限访问该用户故事
        return self._check_permission(request, view, obj)
```

---

### 5.3 各模块功能的实现

#### 5.3.1 登录注册界面实现

**前端登录服务**：

```coffeescript
# app/modules/auth/auth.service.coffee
class AuthService
  constructor: (@http, @storage, @config) ->

  login: (username, password) ->
    data = {username, password, type: "normal"}
    @http.post("#{@config.api}/auth", data)
      .then (response) =>
        @storage.set("token", response.data.auth_token)
        @storage.set("user", response.data)
        response.data
```

#### 5.3.2 项目仪表盘与时间线界面实现

**时间线组件**：

```coffeescript
# app/modules/projects/timeline.directive.coffee
TimelineDirective = () ->
  restrict: "E"
  scope:
    projectId: "="
  template: """
    <div class="timeline">
      <div class="timeline-item" ng-repeat="entry in entries">
        <span class="timeline-date">{{entry.created | date}}</span>
        <span class="timeline-action">{{entry.comment}}</span>
      </div>
    </div>
  """
  controller: ($scope, $rs) ->
    $rs.timeline.get($scope.projectId).then (data) ->
      $scope.entries = data
```

#### 5.3.3 Backlog 规划界面实现

**拖拽排序实现**：

```coffeescript
# app/modules/backlog/backlog-sortable.directive.coffee
BacklogSortableDirective = ($parse) ->
  restrict: "A"
  link: (scope, element, attrs) ->
    drake = dragula([element[0]], {
      moves: (el) -> el.classList.contains("us-card")
    })

    drake.on "drop", (el, target, source, sibling) ->
      beforeId = sibling?.dataset.id
      usId = el.dataset.id
      scope.$apply ->
        scope.reorderUserStory(usId, beforeId)
```

#### 5.3.4 Kanban 拖拽操作界面实现

**看板状态变更**：

```coffeescript
onDrop: (usId, statusId, swimlaneId, beforeId) ->
  data =
    status: statusId
    swimlane: swimlaneId
    order_before: beforeId

  @http.patch("/api/v1/userstories/#{usId}", data)
    .then (response) =>
      @updateLocalState(response.data)
```

#### 5.3.5 任务详情与富文本编辑界面实现

**Markdown 编辑器集成**：

- 使用 Markitup 作为编辑器
- 实时预览 (debounce 300ms)
- 支持拖拽上传图片

#### 5.3.6 统计图表渲染实现

**燃尽图渲染 (Flot.js)**：

```coffeescript
renderBurndown: (data) ->
  ideal = data.map (d) -> [d.date, d.ideal]
  actual = data.map (d) -> [d.date, d.remaining]

  $.plot("#burndown-chart", [
    { data: ideal, label: "理想", color: "#999" }
    { data: actual, label: "实际", color: "#333" }
  ], {
    xaxis: { mode: "time" }
    yaxis: { min: 0 }
  })
```

#### 5.3.7 移动端适配效果

**响应式断点**：

```scss
// app/styles/_responsive.scss
$mobile-breakpoint: 768px;
$tablet-breakpoint: 1024px;

@mixin mobile {
  @media (max-width: $mobile-breakpoint) {
    @content;
  }
}

.kanban-board {
  display: flex;
  @include mobile {
    flex-direction: column; // 移动端垂直堆叠
  }
}
```

---

### 5.4 关键算法与逻辑实现

#### 5.4.1 加权排序算法 (UserStory Order)

```python
def update_userstories_order_in_bulk(project, bulk_data, field):
    """
    批量更新用户故事排序
    使用间隙插入算法，避免频繁重排
    """
    us_orders = []
    for data in bulk_data:
        us = UserStory.objects.get(id=data["us_id"])
        before_us = UserStory.objects.filter(id=data.get("before_id")).first()
        after_us = UserStory.objects.filter(id=data.get("after_id")).first()

        before_order = getattr(before_us, field) if before_us else None
        after_order = getattr(after_us, field) if after_us else None

        new_order = calculate_new_order(before_order, after_order)
        us_orders.append((us, new_order))

    # 批量更新
    for us, order in us_orders:
        setattr(us, field, order)
        us.save(update_fields=[field])
```

#### 5.4.2 搜索查询优化

```python
def build_search_query(text, project_id):
    """构建全文搜索查询"""
    search_vector = SearchVector('subject', weight='A') + \
                    SearchVector('description', weight='B')
    search_query = SearchQuery(text, config='simple')

    return UserStory.objects.annotate(
        search=search_vector,
        rank=SearchRank(search_vector, search_query)
    ).filter(
        project_id=project_id,
        search=search_query
    ).order_by('-rank')
```

#### 5.4.3 异步任务处理 (Celery)

```python
from celery import shared_task

@shared_task
def send_notification_email(user_id, subject, body):
    """异步发送通知邮件"""
    user = User.objects.get(id=user_id)
    send_mail(
        subject=subject,
        message=body,
        from_email=settings.DEFAULT_FROM_EMAIL,
        recipient_list=[user.email]
    )

@shared_task
def export_project_data(project_id, format='json'):
    """异步导出项目数据"""
    project = Project.objects.get(id=project_id)
    data = ProjectExporter(project).export()
    # 保存到临时文件并通知用户下载
```

---

## 第 6 章 测试

本章将介绍本系统的测试策略和测试过程，包括测试目标、测试步骤、测试策略以及具体的测试用例。测试是软件开发过程中的重要环节，通过系统性的测试可以发现和修复缺陷，确保软件质量。

### 6.1 软件测试目标

本系统测试目标包括：

1. **功能正确性**: 验证所有功能按需求规格实现
2. **性能达标**: API 响应时间 < 200ms (P95)
3. **安全性**: 权限控制无越权漏洞
4. **兼容性**: 支持主流浏览器 (Chrome, Firefox, Safari)
5. **稳定性**: 无内存泄漏，长期运行稳定

### 6.2 软件测试步骤

| 阶段     | 测试类型 | 工具              | 职责     |
| -------- | -------- | ----------------- | -------- |
| 开发阶段 | 单元测试 | PyTest, Jasmine   | 开发人员 |
| 集成阶段 | 接口测试 | PyTest + Requests | 测试人员 |
| 系统阶段 | 功能测试 | 手工 + Selenium   | 测试人员 |
| 验收阶段 | UAT      | 手工              | 产品经理 |

### 6.3 单元测试与集成测试策略

#### 6.3.1 后端 API 测试 (PyTest)

**测试结构**：

```
taiga-back/tests/
├── unit/
│   ├── test_models.py
│   ├── test_services.py
│   └── test_validators.py
├── integration/
│   ├── test_userstories_api.py
│   ├── test_tasks_api.py
│   └── test_issues_api.py
└── conftest.py  # pytest fixtures
```

**测试示例**：

```python
# tests/integration/test_userstories_api.py
@pytest.mark.django_db
class TestUserStoryAPI:
    def test_create_userstory(self, client, project, member_token):
        """测试创建用户故事"""
        url = reverse("userstories-list")
        data = {"project": project.id, "subject": "测试故事"}
        response = client.post(url, data, HTTP_AUTHORIZATION=f"Bearer {member_token}")

        assert response.status_code == 201
        assert response.data["subject"] == "测试故事"
        assert response.data["ref"] is not None

    def test_unauthorized_access(self, client, project):
        """测试未授权访问"""
        url = reverse("userstories-list")
        response = client.get(url)
        assert response.status_code == 401
```

#### 6.3.2 前端 Karma/Jasmine 测试

**测试配置**：

```javascript
// karma.conf.js
module.exports = function (config) {
  config.set({
    frameworks: ["jasmine"],
    files: ["app/vendor/**/*.js", "app/modules/**/*.spec.coffee"],
    preprocessors: {
      "**/*.coffee": ["coffee"],
    },
    reporters: ["progress", "coverage"],
  });
};
```

---

### 6.4 测试用例与结果

#### 6.4.1 用户权限测试用例

| 用例编号    | 测试场景             | 预期结果         | 实际结果 |
| ----------- | -------------------- | ---------------- | -------- |
| TC-AUTH-001 | 普通成员访问项目设置 | 403 Forbidden    | ✓ 通过   |
| TC-AUTH-002 | 管理员修改角色权限   | 200 OK           | ✓ 通过   |
| TC-AUTH-003 | 非成员访问私有项目   | 404 Not Found    | ✓ 通过   |
| TC-AUTH-004 | Token 过期后访问 API | 401 Unauthorized | ✓ 通过   |

#### 6.4.2 任务流转逻辑测试用例

| 用例编号    | 测试场景               | 预期结果           | 实际结果 |
| ----------- | ---------------------- | ------------------ | -------- |
| TC-FLOW-001 | 用户故事移入已关闭状态 | is_closed=True     | ✓ 通过   |
| TC-FLOW-002 | 任务完成后重新打开     | finished_date=None | ✓ 通过   |
| TC-FLOW-003 | 冲刺关闭后任务状态     | 任务保持当前状态   | ✓ 通过   |

#### 6.4.3 批量操作性能测试

| 测试场景       | 数据量     | 响应时间 | 结果   |
| -------------- | ---------- | -------- | ------ |
| 批量更新排序   | 100 条     | 320ms    | ✓ 达标 |
| 批量移动到冲刺 | 50 条      | 180ms    | ✓ 达标 |
| 项目导出       | 1000 条 US | 2.5s     | ✓ 达标 |

#### 6.4.4 API 边界值测试

| 用例编号    | 测试场景       | 输入     | 预期结果        |
| ----------- | -------------- | -------- | --------------- |
| TC-EDGE-001 | 用户名最大长度 | 255 字符 | 201 Created     |
| TC-EDGE-002 | 用户名超长     | 256 字符 | 400 Bad Request |
| TC-EDGE-003 | 故事点空值     | null     | 正常处理        |
| TC-EDGE-004 | 负数排序值     | -1000000 | 正常排序        |

---

## 第 7 章 维护

本章将介绍本系统的维护过程和维护策略。软件维护是软件生命周期中持续时间最长、成本最高的阶段，良好的维护策略可以延长软件的使用寿命，保障系统的稳定运行。

### 7.1 系统维护过程

系统维护过程主要包括版本控制、部署管理、数据备份和日志监控等方面。

#### 代码版本控制 (Git)

**分支策略**：

```
main          # 生产分支
├── develop   # 开发分支
├── feature/* # 功能分支
├── hotfix/*  # 热修复分支
└── release/* # 发布分支
```

**版本号规范** (Semantic Versioning):

- MAJOR.MINOR.PATCH (如 6.9.0)
- MAJOR: 不兼容的 API 变更
- MINOR: 向后兼容的功能新增
- PATCH: 向后兼容的问题修复

#### Docker 容器化部署

**docker-compose.yml 结构**：

```yaml
version: "3.8"
services:
  taiga-back:
    image: taigaio/taiga-back:latest
    environment:
      - POSTGRES_HOST=db
      - REDIS_HOST=redis
    depends_on:
      - db
      - redis

  taiga-front:
    image: taigaio/taiga-front:latest
    ports:
      - "80:80"

  db:
    image: postgres:14
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7
```

### 7.2 系统维护策略

#### 数据库备份与恢复策略

| 备份类型 | 频率   | 保留期 | 工具     |
| -------- | ------ | ------ | -------- |
| 全量备份 | 每日   | 30 天  | pg_dump  |
| 增量备份 | 每小时 | 7 天   | WAL 归档 |
| 远程备份 | 每周   | 90 天  | S3/OSS   |

**恢复流程**：

```bash
# 恢复全量备份
pg_restore -d taiga_db backup.dump

# 恢复到指定时间点
pg_basebackup + WAL replay
```

#### 日志监控与错误追踪

**监控工具**：

- **Sentry**: 错误追踪与告警
- **Prometheus**: 性能指标采集
- **Grafana**: 可视化仪表盘

**关键监控指标**：

- API 响应时间 (P50, P95, P99)
- 数据库连接数
- Redis 内存使用率
- Celery 任务队列长度

---

## 第 8 章 总结与体会

本章对整个项目开发过程进行总结，并分享在项目分析和文档编写过程中的心得体会。

### 8.1 总结

在开始系统设计与实现前，项目组进行了大量的讨论与调研，在前两周完成了系统的可行性分析、需求分析和总体设计部分。基本结构确定后，后四周进行了详细设计和系统实现分析。最后两周完成了测试策略制定和文档完善，实现了各模块的功能分析。

本文档对敏捷项目管理平台进行了全面的软件工程分析，主要内容包括：

1. **可行性研究**: 完成技术、经济可行性分析，证明基于 Taiga/Tenzu 的技术方案成熟可靠
2. **需求分析**: 梳理 44 项功能需求，建立完整的 E-R 模型和数据字典
3. **总体设计**: 设计前后端分离架构，定义 10 个核心模块的 IPO
4. **详细设计**: 深入分析 9 大功能模块的实现逻辑
5. **系统实现**: 展示核心代码实现，包括 Model、ViewSet、Permission
6. **测试**: 制定测试策略，执行功能、性能、安全测试

**技术亮点**：

- Django-Ninja 构建标准化 API
- PostgreSQL JSONB 支持灵活的自定义属性
- Celery 异步处理提升系统响应性
- WebSocket 实现实时协作体验

### 8.2 体会

通过对本系统的深入分析，体会到：

1. **开源软件的价值**: Taiga/Tenzu 作为开源项目，代码质量高，架构清晰，是学习软件工程的优秀案例
2. **敏捷方法论的实践**: 本系统不仅是敏捷工具，其开发过程本身也遵循敏捷原则
3. **前后端分离的优势**: 清晰的 API 边界使得前后端可独立开发和部署
4. **自动化测试的重要性**: 完善的测试套件保障了系统质量和重构信心

---

## 第 9 章 附录

本章提供项目相关的补充资料，包括核心数据库表的 SQL 定义、API 接口文档概览和配置文件说明等。

### 附录 A：核心数据库表 SQL 定义

```sql
-- 用户表
CREATE TABLE users_user (
    id SERIAL PRIMARY KEY,
    uuid CHAR(32) UNIQUE NOT NULL,
    username VARCHAR(255) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(128) NOT NULL,
    full_name VARCHAR(256),
    is_active BOOLEAN DEFAULT TRUE,
    date_joined TIMESTAMP NOT NULL
);

-- 项目表
CREATE TABLE projects_project (
    id SERIAL PRIMARY KEY,
    name VARCHAR(250) NOT NULL,
    slug VARCHAR(250) UNIQUE,
    description TEXT,
    owner_id INTEGER REFERENCES users_user(id),
    is_private BOOLEAN DEFAULT TRUE,
    created_date TIMESTAMP NOT NULL
);

-- 用户故事表
CREATE TABLE userstories_userstory (
    id SERIAL PRIMARY KEY,
    ref BIGINT,
    project_id INTEGER REFERENCES projects_project(id),
    milestone_id INTEGER,
    subject TEXT NOT NULL,
    is_closed BOOLEAN DEFAULT FALSE,
    backlog_order BIGINT NOT NULL,
    created_date TIMESTAMP NOT NULL
);
```

### 附录 B：API 接口文档概览

| 模块     | 端点                  | 方法     | 说明           |
| -------- | --------------------- | -------- | -------------- |
| 认证     | /api/v1/auth          | POST     | 用户登录       |
| 认证     | /api/v1/auth/register | POST     | 用户注册       |
| 用户     | /api/v1/users/me      | GET      | 获取当前用户   |
| 项目     | /api/v1/projects      | GET/POST | 项目列表/创建  |
| 用户故事 | /api/v1/userstories   | GET/POST | 故事列表/创建  |
| 任务     | /api/v1/tasks         | GET/POST | 任务列表/创建  |
| 冲刺     | /api/v1/milestones    | GET/POST | 冲刺列表/创建  |
| 问题     | /api/v1/issues        | GET/POST | 问题列表/创建  |
| Wiki     | /api/v1/wiki          | GET/POST | Wiki 列表/创建 |

### 附录 C：配置文件说明

**后端配置 (settings/local.py)**：

```python
# 数据库配置
DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.postgresql",
        "NAME": "taiga",
        "USER": "taiga",
        "PASSWORD": "changeme",
        "HOST": "localhost",
        "PORT": "5432",
    }
}

# Redis 配置
CELERY_BROKER_URL = "redis://localhost:6379/0"
CACHES = {
    "default": {
        "BACKEND": "django_redis.cache.RedisCache",
        "LOCATION": "redis://localhost:6379/1",
    }
}

# 邮件配置
EMAIL_BACKEND = "django.core.mail.backends.smtp.EmailBackend"
EMAIL_HOST = "smtp.example.com"
EMAIL_PORT = 587
```

**前端配置 (conf.json)**：

```json
{
  "api": "https://api.example.com/api/v1",
  "eventsUrl": "wss://events.example.com/events",
  "debug": false,
  "defaultLanguage": "zh-hans",
  "themes": ["taiga", "material-design", "high-contrast"],
  "feedbackEnabled": true
}
```

---

### 附录 D：Taiga REST API 端点汇总

基于 https://docs.taiga.io/api.html 整理的核心 API 端点：

#### D.1 认证 API

| 端点                    | 方法 | 说明       |
| ----------------------- | ---- | ---------- |
| `/api/v1/auth`          | POST | 登录       |
| `/api/v1/auth/refresh`  | POST | 刷新 Token |
| `/api/v1/auth/register` | POST | 注册       |

#### D.2 项目管理 API

| 端点                                   | 方法           | 说明         |
| -------------------------------------- | -------------- | ------------ |
| `/api/v1/projects`                     | GET            | 项目列表     |
| `/api/v1/projects`                     | POST           | 创建项目     |
| `/api/v1/projects/{id}`                | GET/PUT/DELETE | 项目详情     |
| `/api/v1/projects/by_slug?slug={slug}` | GET            | 按 slug 获取 |

#### D.3 用户故事 API

| 端点                                            | 方法     | 说明                  |
| ----------------------------------------------- | -------- | --------------------- |
| `/api/v1/userstories`                           | GET/POST | 列表/创建             |
| `/api/v1/userstories/bulk_create`               | POST     | 批量创建              |
| `/api/v1/userstories/bulk_update_backlog_order` | POST     | 批量更新 Backlog 排序 |
| `/api/v1/userstories/bulk_update_kanban_order`  | POST     | 批量更新看板排序      |

#### D.4 其他核心 API

| 模块    | 端点                 |
| ------- | -------------------- |
| 任务    | `/api/v1/tasks`      |
| 里程碑  | `/api/v1/milestones` |
| 史诗    | `/api/v1/epics`      |
| 问题    | `/api/v1/issues`     |
| Wiki    | `/api/v1/wiki`       |
| Webhook | `/api/v1/webhooks`   |

---

**文档结束**
